<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Î™®ÎπÑ Ï∑ç</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-primary: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            --bg-secondary: #ffffff;
            --bg-accent: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --hover-bg: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            --weekly-bg: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            --weekly-hover: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
            --completed-bg: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            --completed-hover: linear-gradient(135deg, #bbf7d0 0%, #86efac 100%);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --success: #10b981;
            --success-hover: #059669;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #8b5cf6;
            --made-by: rgba(255 255 255 / 20%);
        }

        html[data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --bg-secondary: #1e293b;
            --bg-accent: linear-gradient(135deg, #334155 0%, #475569 100%);
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --border-color: #475569;
            --hover-bg: linear-gradient(135deg, #1e40af 0%, #1d4ed8 100%);
            --weekly-bg: linear-gradient(135deg, #92400e 0%, #b45309 100%);
            --weekly-hover: linear-gradient(135deg, #b45309 0%, #d97706 100%);
            --completed-bg: linear-gradient(135deg, #065f46 0%, #047857 100%);
            --completed-hover: linear-gradient(135deg, #047857 0%, #059669 100%);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --primary: #60a5fa;
            --primary-hover: #3b82f6;
            --success: #34d399;
            --success-hover: #10b981;
        }

        .account-daily-badge {
            display: inline-block;
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            margin-right: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow);
        }

        .account-weekly-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--purple), #7c3aed);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            margin-right: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow);
        }

        tr.account-daily {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        tr.account-daily:hover {
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
        }

        tr.account-weekly {
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
        }

        tr.account-weekly:hover {
            background: linear-gradient(135deg, #e9d5ff 0%, #ddd6fe 100%);
        }

        /* Îã§ÌÅ¨Î™®Îìú */
        html[data-theme="dark"] tr.account-daily {
            background: linear-gradient(135deg, #164e63 0%, #0e7490 100%);
        }

        html[data-theme="dark"] tr.account-daily:hover {
            background: linear-gradient(135deg, #0e7490 0%, #0891b2 100%);
        }

        html[data-theme="dark"] tr.account-weekly {
            background: linear-gradient(135deg, #581c87 0%, #6b21a8 100%);
        }

        html[data-theme="dark"] tr.account-weekly:hover {
            background: linear-gradient(135deg, #6b21a8 0%, #7c2d92 100%);
        }

        html.theme-transitioning body,
        html.theme-transitioning .top-controls,
        html.theme-transitioning .stat-card,
        html.theme-transitioning .timer-card,
        html.theme-transitioning .character-box,
        html.theme-transitioning .quest-management,
        html.theme-transitioning .tabs,
        html.theme-transitioning table,
        html.theme-transitioning th,
        html.theme-transitioning td {
            transition: background-color 0.2s ease,
                color 0.2s ease,
                border-color 0.2s ease !important;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Malgun Gothic', 'ÎßëÏùÄ Í≥†Îîï', sans-serif;
            background: var(--bg-primary);
            margin: 0;
            padding: 20px;
            color: var(--text-primary);
            min-height: 100vh;
        }

        h1 {
            text-align: center;
            color: var(--text-primary);
            margin: 0 0 30px 0;
            font-size: clamp(24px, 4vw, 32px);
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            background: linear-gradient(135deg, var(--primary), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .top-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
        }

        .character-management {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 0;
            background: transparent;
            border-radius: 0;
            box-shadow: none;
            min-width: 300px;
            margin: 0;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--success), var(--success-hover));
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--success-hover), #047857);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #4b5563, #374151);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .add-character input {
            max-width: 300px;
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
            background: var(--bg-secondary);
            color: var(--text-primary);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .add-character input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        .stats-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--purple), var(--success));
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .stat-card h4 {
            margin: 0 0 12px 0;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
            background: linear-gradient(135deg, var(--primary), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .reset-timer {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .timer-card {
            padding: 20px 24px;
            background: var(--bg-secondary);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            text-align: center;
            transition: all 0.3s ease;
            min-width: 180px;
            backdrop-filter: blur(10px);
        }

        .timer-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .timer-card h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .timer-card .time {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Courier New', monospace;
        }

        .tabs {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 24px;
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        .tab-btn {
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            font-weight: 600;
            position: relative;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tab-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary), var(--purple));
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 12px;
            z-index: -1;
        }

        .tab-btn:hover::before {
            opacity: 0.1;
        }

        .tab-btn.active::before {
            opacity: 1;
        }

        .tab-btn.active {
            color: white;
            z-index: 1;
            position: relative;
        }

        .theme-toggle {
            min-width: 50px;
            position: relative;
            pointer-events: auto !important;
            z-index: 100;
            background: linear-gradient(135deg, #6b7280, #4b5563) !important;
            border: none !important;
            border-radius: 12px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 600 !important;
            text-decoration: none !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 8px !important;
            overflow: visible !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            padding: 12px 20px !important;
            color: white !important;
            box-shadow: var(--shadow) !important;
            transition: background 0.2s ease,
                transform 0.2s ease,
                box-shadow 0.2s ease !important;
        }

        .theme-toggle:hover:not(:disabled) {
            background: linear-gradient(135deg, #4b5563, #374151) !important;
            transform: translateY(-2px) !important;
            box-shadow: var(--shadow-lg) !important;
        }

        .theme-toggle:active:not(:disabled) {
            transform: translateY(0) !important;
            transition: transform 0.1s ease !important;
        }

        .theme-toggle:disabled {
            opacity: 0.7 !important;
            cursor: not-allowed !important;
            pointer-events: none !important;
            transform: none !important;
        }

        .theme-toggle::before {
            display: none !important;
        }

        .theme-toggle::after {
            display: none !important;
        }

        .theme-icon {
            font-size: 18px !important;
            transition: transform 0.2s ease !important;
            pointer-events: none !important;
            display: block !important;
        }

        .theme-toggle:hover:not(:disabled) .theme-icon {
            transform: rotate(20deg) scale(1.1) !important;
        }

        .theme-toggle:disabled .theme-icon {
            transform: none !important;
            opacity: 0.7 !important;
        }

        .tab-btn,
        .btn,
        .character-box,
        .stat-card,
        input[type="checkbox"] {
            will-change: transform;
        }

        html.theme-transitioning .tab-btn,
        html.theme-transitioning .btn,
        html.theme-transitioning .character-box,
        html.theme-transitioning .stat-card {
            will-change: background-color, color, border-color;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-accent);
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--purple));
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-hover), #7c3aed);
        }

        .stat-card,
        .timer-card,
        .character-box,
        .quest-management {
            transition: background-color 0.3s ease,
                box-shadow 0.3s ease,
                border-color 0.3s ease;
        }

        table,
        th,
        td {
            transition: background-color 0.3s ease,
                color 0.3s ease,
                border-color 0.3s ease;
        }

        input,
        select,
        textarea {
            transition: background-color 0.3s ease,
                color 0.3s ease,
                border-color 0.3s ease,
                box-shadow 0.3s ease;
        }

        input[type="checkbox"] {
            transition: background-color 0.3s ease,
                border-color 0.3s ease,
                box-shadow 0.3s ease,
                transform 0.2s ease;
        }

        .progress-bar,
        .progress-fill {
            transition: background-color 0.3s ease;
        }

        .weekly-badge,
        .daily-badge {
            transition: background 0.3s ease, color 0.3s ease;
        }

        .character-box {
            background: var(--bg-secondary);
            box-shadow: var(--shadow-lg);
            border-radius: 20px;
            padding: 24px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            backdrop-filter: blur(10px);
        }

        .character-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--purple), var(--success));
        }

        .character-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .character-box h3 {
            margin-top: 0;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 12px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 700;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            background: var(--bg-secondary);
        }

        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 14px;
            background: var(--bg-secondary);
        }

        th {
            background: var(--bg-accent);
            font-weight: 700;
            color: var(--text-primary);
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 16px 12px;
            text-align: center;
            word-wrap: break-word;
            border: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 12px;
        }

        td {
            padding: 14px 12px;
            text-align: center;
            word-wrap: break-word;
            border: none;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        tr.weekly {
            background: var(--weekly-bg);
        }

        tr.weekly:hover {
            background: var(--weekly-hover);
        }

        .completed {
            background: var(--completed-bg) !important;
            transition: background 0.3s ease;
        }

        .completed:hover {
            background: var(--completed-hover) !important;
        }

        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 22px;
            height: 22px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            cursor: pointer;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        input[type="checkbox"]:hover {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: scale(1.1);
        }

        input[type="checkbox"]:checked {
            background: linear-gradient(135deg, var(--success), var(--success-hover));
            border-color: var(--success-hover);
            animation: checkBounce 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        input[type="checkbox"]:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
            animation: checkAppear 0.3s ease 0.1s both;
        }

        .checker {
            width: 26px;
            height: 26px;
            border-radius: 10px;
        }

        .individual-checker {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            margin: 2px;
        }

        .weekly-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            margin-right: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow);
        }

        .daily-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary), #1d4ed8);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            margin-right: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow);
        }

        .progress-info {
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg-accent);
            border-radius: 12px;
            font-size: 14px;
            color: var(--text-secondary);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 20px;
            overflow: hidden;
            margin: 12px 0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--success-hover));
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 20px;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: progressShine 2s infinite;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }

        .filter-group select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .filter-group select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .layout-btn {
            padding: 10px 14px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 45px;
            box-shadow: var(--shadow);
        }

        .layout-btn:hover {
            border-color: var(--primary);
            background: var(--hover-bg);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .layout-btn.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary), var(--primary-hover));
            color: white;
            box-shadow: var(--shadow-lg);
        }

        @keyframes checkBounce {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(0.8);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes checkAppear {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }

            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @keyframes progressShine {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            border-radius: 20px;
            box-shadow: var(--shadow);
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .top-controls {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .character-management {
                min-width: unset;
                width: 100%;
            }

            .stats-display {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-card .value {
                font-size: 24px;
            }

            .reset-timer {
                gap: 15px;
            }

            .timer-card {
                min-width: 150px;
                padding: 15px 20px;
            }

            .character-box {
                padding: 20px;
            }

            th,
            td {
                padding: 12px 8px;
                font-size: 13px;
            }

            .tab-btn {
                padding: 12px 16px;
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .character-management {
                flex-direction: column;
                gap: 10px;
            }

            .add-character {
                width: 100%;
            }

            .filters-stats {
                flex-direction: column;
                gap: 10px;
            }

            .filter-group {
                width: 100%;
                justify-content: space-between;
            }

            .stat-card .value {
                font-size: 20px;
            }

            th,
            td {
                padding: 10px 6px;
                font-size: 12px;
            }
        }

        .filters-stats {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: end;
            margin-bottom: 15px;
            margin-left: auto;
        }

        .data-controls {
            display: flex;
            gap: 8px;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
            display: block;
            margin: 10px 0 0 auto;
            box-shadow: var(--shadow);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .character-filters-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .character-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            flex: 1;
            min-width: 300px;
        }

        .character-tabs:empty {
            display: none;
        }

        .delete-char {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .tab-btn.character-tab:hover .delete-char {
            display: flex;
        }

        .delete-char:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .character {
            display: none;
            padding: 24px 30px;
            background: var(--bg-secondary);
            box-shadow: var(--shadow-lg);
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .character.active {
            display: block;
        }

        .all-characters {
            display: none;
        }

        .all-characters.active {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 500px), 1fr));
            gap: 20px;
        }

        .edit-name {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: inherit;
            font-weight: inherit;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .edit-name:hover {
            background: var(--bg-accent);
            transform: scale(1.05);
        }

        .memo-input {
            width: 100%;
            min-height: 70px;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            resize: vertical;
            margin-top: 8px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            font-family: inherit;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .memo-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .save-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--success), var(--success-hover));
            color: white;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }

        .save-status.show {
            opacity: 1;
            transform: translateY(0);
        }

        .save-status.error {
            background: linear-gradient(135deg, var(--danger), #dc2626);
        }

        .hidden {
            display: none !important;
        }

        .quest-management {
            margin-bottom: 20px;
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
        }

        .quest-management h3 {
            margin: 0 0 20px 0;
            color: var(--text-primary);
            text-align: center;
            font-size: 20px;
            font-weight: 700;
        }

        .add-quest-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .add-quest-form input,
        .add-quest-form select {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .add-quest-form input:focus,
        .add-quest-form select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .quest-list {
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            background: var(--bg-secondary);
            box-shadow: var(--shadow);
        }

        .quest-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .quest-item:last-child {
            border-bottom: none;
        }

        .quest-item:hover {
            background: var(--bg-accent);
            transform: translateX(4px);
        }

        .quest-info {
            flex: 1;
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .quest-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-edit {
            background: linear-gradient(135deg, var(--primary), var(--primary-hover));
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-edit:hover {
            background: linear-gradient(135deg, var(--primary-hover), #1d4ed8);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-delete {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-delete:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .progress-container .individual-checker {
            margin: 3px 4px;
            transition: all 0.2s ease;
        }

        .progress-container .individual-checker:hover {
            transform: scale(1.15);
            z-index: 1;
            position: relative;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .progress-text {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 8px;
            font-weight: 600;
            white-space: nowrap;
        }

        tr.completed .checker,
        tr.completed .individual-checker {
            border-color: var(--success-hover);
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }

        .layout-controls-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
        }

        .layout-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .layout-controls label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
            margin-right: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .all-characters.layout-1 {
            grid-template-columns: 1fr !important;
        }

        .all-characters.layout-2 {
            grid-template-columns: repeat(2, 1fr) !important;
        }

        .all-characters.layout-3 {
            grid-template-columns: repeat(3, 1fr) !important;
        }

        .all-characters.layout-4 {
            grid-template-columns: repeat(4, 1fr) !important;
        }

        @media (max-width: 1400px) {
            .all-characters.layout-4 {
                grid-template-columns: repeat(3, 1fr) !important;
            }
        }

        @media (max-width: 1024px) {

            .all-characters.layout-3,
            .all-characters.layout-4 {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            .character-filters-container {
                flex-direction: column;
                gap: 15px;
            }

            .character-tabs {
                justify-content: center;
                min-width: unset;
            }

            .filters-stats {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
        }

        @media (max-width: 768px) {

            .all-characters.layout-2,
            .all-characters.layout-3,
            .all-characters.layout-4 {
                grid-template-columns: 1fr !important;
            }

            .layout-controls-container {
                padding: 15px;
            }

            .layout-btn {
                padding: 8px 12px;
                font-size: 12px;
                min-width: 40px;
            }

            .filters-stats {
                flex-direction: column;
                gap: 10px;
            }

            .filter-group {
                width: 100%;
                justify-content: space-between;
            }

            .layout-controls {
                width: 100%;
                justify-content: center;
            }

            .add-quest-form {
                grid-template-columns: 1fr;
            }

            .quest-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }

        @media (max-width: 480px) {
            .character-filters-container {
                gap: 12px;
            }

            .quest-item {
                padding: 12px 15px;
            }

            .quest-management {
                padding: 20px;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-accent);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--purple));
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-hover), #7c3aed);
        }

        .draggable-item {
            cursor: move;
            transition: all 0.3s ease;
        }

        .draggable-item:hover {
            box-shadow: var(--shadow-lg);
        }

        .draggable-item.dragging {
            opacity: 0.6;
            transform: rotate(2deg) scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        input[type="checkbox"].loading {
            border-color: var(--primary);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.7;
                transform: scale(1.05);
            }
        }

        input[type="checkbox"]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        input[type="checkbox"]:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .stat-card h4::before {
            content: 'üìä';
            margin-right: 8px;
        }

        .stat-card:nth-child(1) h4::before {
            content: 'üìà';
        }

        .stat-card:nth-child(2) h4::before {
            content: '‚òÄÔ∏è';
        }

        .stat-card:nth-child(3) h4::before {
            content: 'üìÖ';
        }

        .stat-card:nth-child(4) h4::before {
            content: 'üë•';
        }

        .tab-btn,
        .btn,
        .character-box,
        .stat-card,
        input[type="checkbox"] {
            will-change: transform;
        }

        *:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Ïû¨Î£å Í¥ÄÎ¶¨ Ï†ÑÏö© Ïä§ÌÉÄÏùº */
        .material-form {
            grid-template-columns: 1fr auto;
            max-width: 600px;
            margin: 0 auto;
        }

        .material-input-container {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            padding: 8px;
        }

        .material-count-input {
            width: 80px;
            padding: 6px 8px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .material-count-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .material-badge {
            display: inline-block;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            margin-right: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow);
        }

        .material-section {
            margin-bottom: 20px;
        }

        .material-section h4 {
            margin: 15px 0 10px 0;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .material-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .material-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-accent);
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .material-item:hover {
            background: var(--hover-bg);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .material-item-name {
            flex: 1;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .material-count-display {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 8px;
        }

        @media (max-width: 768px) {
            .material-form {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .material-grid {
                grid-template-columns: 1fr;
                gap: 8px;
                padding: 12px;
            }

            .material-item {
                padding: 10px;
            }
        }

        @media (max-width: 480px) {
            .material-input-container {
                flex-direction: column;
                gap: 6px;
            }

            .material-count-input {
                width: 60px;
            }
        }

        .made-by {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 14px;
            color: var(--made-by);
            text-align: left;
        }
    </style>
</head>

<body>
    <h1>üéÆ Î™®ÎπÑ Ï∑ç!!!</h1>

    <div class="top-controls">
        <div class="character-management">
            <div class="add-character">
                <input type="text" id="newCharName" placeholder="Ï∫êÎ¶≠ÌÑ∞Î™Ö ÏûÖÎ†•" maxlength="20">
                <button class="btn btn-primary" onclick="addCharacter()">‚ûï Ï∂îÍ∞Ä</button>
            </div>
            <div class="data-controls">
                <button class="btn btn-secondary" onclick="exportData()" title="Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞">üìÅ</button>
                <label class="btn btn-secondary" for="importFile" title="Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞">üìÇ</label>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            </div>
            <button class="btn btn-secondary theme-toggle" onclick="toggleTheme()" title="Îã§ÌÅ¨Î™®Îìú Ï†ÑÌôò" type="button">
                <span class="theme-icon">üåô</span>
            </button>
        </div>
    </div>

    <div class="stats-display" id="statsDisplay">
        <div class="stat-card">
            <h4>Ï†ÑÏ≤¥ ÏôÑÎ£åÏú®</h4>
            <div class="value" id="totalCompletion">0%</div>
        </div>
        <div class="stat-card">
            <h4>ÏùºÍ∞Ñ ÏôÑÎ£åÏú®</h4>
            <div class="value" id="dailyCompletion">0%</div>
        </div>
        <div class="stat-card">
            <h4>Ï£ºÍ∞Ñ ÏôÑÎ£åÏú®</h4>
            <div class="value" id="weeklyCompletion">0%</div>
        </div>
        <div class="stat-card">
            <h4>ÌôúÏÑ± Ï∫êÎ¶≠ÌÑ∞</h4>
            <div class="value" id="activeCharacters">0</div>
        </div>
    </div>

    <div class="reset-timer">
        <div class="timer-card">
            <h4>üîÑ ÏùºÍ∞Ñ Î¶¨ÏÖãÍπåÏßÄ</h4>
            <div class="time" id="dailyTimer">--:--:--</div>
        </div>
        <div class="timer-card">
            <h4>üìÖ Ï£ºÍ∞Ñ Î¶¨ÏÖãÍπåÏßÄ</h4>
            <div class="time" id="weeklyTimer">-- Ïùº --:--:--</div>
        </div>
    </div>

    <div class="tabs" id="tabContainer">
        <button class="tab-btn overview-tab" data-target="#tradeManagement">üì¶ Î¨ºÎ¨ºÍµêÌôò Í¥ÄÎ¶¨</button>
        <button class="tab-btn overview-tab" data-target="#questManagement">‚öîÔ∏è ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨</button>
        <button class="tab-btn overview-tab" data-target="#materialManagement">üß∞ Ïû¨Î£å Í¥ÄÎ¶¨</button>
    </div>

    <div class="character-filters-container">
        <div class="character-tabs" id="characterTabContainer">
            <button class="tab-btn overview-tab active" data-target="#allView">üìã Ï†ÑÏ≤¥ Î≥¥Í∏∞</button>
            <!-- Ï∫êÎ¶≠ÌÑ∞ ÌÉ≠ ÎèôÏ†Å Ï∂îÍ∞Ä -->
        </div>

        <div class="filters-stats">
            <div class="filter-group">
                <label>ÌÉÄÏûÖ:</label>
                <select id="typeFilter" onchange="applyFilters()">
                    <option value="all">Ï†ÑÏ≤¥</option>
                    <option value="daily">ÏùºÍ∞Ñ</option>
                    <option value="weekly">Ï£ºÍ∞Ñ</option>
                    <option value="accountDaily">Í≥ÑÏ†ïÏùºÍ∞Ñ</option>
                    <option value="accountWeekly">Í≥ÑÏ†ïÏ£ºÍ∞Ñ</option>
                </select>
            </div>
            <div class="filter-group">
                <label>ÏÉÅÌÉú:</label>
                <select id="statusFilter" onchange="applyFilters()">
                    <option value="all">Ï†ÑÏ≤¥</option>
                    <option value="completed">ÏôÑÎ£å</option>
                    <option value="incomplete">ÎØ∏ÏôÑÎ£å</option>
                </select>
            </div>
            <div class="filter-group">
                <label>ÏßÄÏó≠:</label>
                <select id="locationFilter" onchange="applyFilters()">
                    <option value="all">Ï†ÑÏ≤¥</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Ï†ïÎ†¨:</label>
                <select id="sortFilter" onchange="applyFilters()">
                    <option value="default">Í∏∞Î≥∏Ïàú</option>
                    <option value="location">ÏßÄÏó≠Ïàú</option>
                    <option value="reward">Î≥¥ÏÉÅÏàú</option>
                    <option value="type">ÌÉÄÏûÖÏàú</option>
                </select>
            </div>
            <div class="layout-controls">
                <label>Î†àÏù¥ÏïÑÏõÉ:</label>
                <button class="layout-btn" onclick="changeLayout(1)" title="1Ïó¥">1</button>
                <button class="layout-btn active" onclick="changeLayout(2)" title="2Ïó¥">2</button>
                <button class="layout-btn" onclick="changeLayout(3)" title="3Ïó¥">3</button>
                <button class="layout-btn" onclick="changeLayout(4)" title="4Ïó¥">4</button>
            </div>
        </div>
    </div>

    <!-- Ï†ÑÏ≤¥Î≥¥Í∏∞ -->
    <div class="all-characters active" id="allView">
        <div class="empty-state" id="emptyState">
            <h3>Îì±Î°ùÎêú Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</h3>
            <p>ÏúÑÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞Î•º Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî!</p>
        </div>
    </div>

    <!-- Î¨ºÎ¨ºÍµêÌôò Í¥ÄÎ¶¨ -->
    <div class="all-characters" id="tradeManagement">
        <div class="quest-management">
            <h3>üì¶ Î¨ºÎ¨ºÍµêÌôò Ï∂îÍ∞Ä/ÏàòÏ†ï</h3>
            <div class="add-quest-form">
                <select id="questType">
                    <option value="daily">ÏùºÍ∞Ñ</option>
                    <option value="weekly">Ï£ºÍ∞Ñ</option>
                    <option value="accountDaily">Í≥ÑÏ†ïÏùºÍ∞Ñ</option>
                    <option value="accountWeekly">Í≥ÑÏ†ïÏ£ºÍ∞Ñ</option>
                </select>
                <input type="text" id="questLocation" placeholder="ÏúÑÏπò (Ïòà: Ìã∞Î•¥ÏΩîÎÑ§Ïùº)" maxlength="20">
                <input type="text" id="questNpc" placeholder="NPCÎ™Ö (Ïòà: ÌçºÍ±∞Ïä§)" maxlength="20">
                <input type="text" id="questNeed" placeholder="ÌïÑÏöîÏïÑÏù¥ÌÖú (Ïòà: Í∞ïÏ≤†Í¥¥)" maxlength="30">
                <input type="number" id="questNeedCount" placeholder="ÌïÑÏöîÏàòÎüâ" min="1" max="9999">
                <input type="text" id="questReward" placeholder="Î≥¥ÏÉÅÏïÑÏù¥ÌÖú (Ïòà: Ìï©Í∏àÍ∞ïÍ¥¥)" maxlength="30">
                <input type="number" id="questRewardCount" placeholder="Î≥¥ÏÉÅÏàòÎüâ" min="1" max="9999">
                <button class="btn btn-primary" onclick="addQuest()" id="addQuestBtn">‚ûï ÌÄòÏä§Ìä∏ Ï∂îÍ∞Ä</button>
            </div>

            <h3 style="margin-top: 30px;">üìã ÌòÑÏû¨ Î¨ºÎ¨ºÍµêÌôò Î™©Î°ù</h3>
            <div class="quest-list" id="questList">
                <!-- Î¨ºÎ¨ºÍµêÌôò Î™©Î°ù ÌëúÏãú -->
            </div>
        </div>
    </div>

    <!-- ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨ -->
    <div class="all-characters" id="questManagement">
        <div class="quest-management">
            <h3>‚öîÔ∏è ÌÄòÏä§Ìä∏ Ï∂îÍ∞Ä/ÏàòÏ†ï</h3>
            <div class="add-quest-form">
                <select id="questMgmtType">
                    <option value="daily">ÏùºÍ∞Ñ</option>
                    <option value="weekly">Ï£ºÍ∞Ñ</option>
                    <option value="accountDaily">Í≥ÑÏ†ïÏùºÍ∞Ñ</option>
                    <option value="accountWeekly">Í≥ÑÏ†ïÏ£ºÍ∞Ñ</option>
                </select>
                <input type="text" id="questMgmtName" placeholder="ÌÄòÏä§Ìä∏Î™Ö (Ïòà: ÌïÑÎìúÎ≥¥Ïä§)" maxlength="30">
                <input type="number" id="questMgmtCount" placeholder="ÌöüÏàò" min="1" max="99">
                <input type="text" id="questMgmtCategory" placeholder="Ïπ¥ÌÖåÍ≥†Î¶¨ (Ïòà: Ï†ÑÌà¨)" maxlength="20">
                <button class="btn btn-primary" onclick="addQuestManagement()" id="addQuestMgmtBtn">‚ûï ÌÄòÏä§Ìä∏ Ï∂îÍ∞Ä</button>
            </div>

            <h3 style="margin-top: 30px;">üìã ÌòÑÏû¨ ÌÄòÏä§Ìä∏ Î™©Î°ù</h3>
            <div class="quest-list" id="questMgmtList">
                <!-- ÌÄòÏä§Ìä∏ Î™©Î°ù ÌëúÏãú -->
            </div>
        </div>
    </div>

    <!-- Ïû¨Î£å Í¥ÄÎ¶¨ -->
    <div class="all-characters" id="materialManagement">
        <div class="quest-management">
            <h3>üß∞ Ïû¨Î£å Ï∂îÍ∞Ä/ÏàòÏ†ï</h3>
            <div class="add-quest-form material-form">
                <input type="text" id="materialName" placeholder="Ïû¨Î£åÎ™Ö (Ïòà: Í∞ïÏ≤†Í¥¥)" maxlength="30">
                <button class="btn btn-primary" onclick="addMaterial()" id="addMaterialBtn">‚ûï Ïû¨Î£å Ï∂îÍ∞Ä</button>
            </div>

            <h3 style="margin-top: 30px;">üìã ÌòÑÏû¨ Ïû¨Î£å Î™©Î°ù</h3>
            <div class="quest-list" id="materialList">
                <!-- Ïû¨Î£å Î™©Î°ù ÌëúÏãú -->
            </div>
        </div>
    </div>

    <div class="save-status" id="saveStatus">Ï†ÄÏû•Îê®</div>
    <div class="made-by">made by<br>ÎÇ¥Î©ãÎåÄÎ°úÎßâÍ∞Ä(Îç∞Ïù¥Ïïà)</div>

    <script>
        // ÌÄòÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï†ïÏùò (Î¨ºÎ¨ºÍµêÌôò)
        let questData = [
            { type: 'weekly', location: 'Î∞òÌò∏Î•¥', npc: 'ÏïÑÏù¥Îç∞Î•∏', need: 'ÎÜçÏñ¥ Îß§Ïö¥ÌÉï', needCount: 1, reward: 'ÏùÄÌï©Í∏àÍ¥¥', rewardCount: 10 },
            { type: 'weekly', location: 'Ìã∞Î•¥ÏΩîÎÑ§Ïùº', npc: 'ÏóîÎç∏Î¶¨Ïò®', need: 'ÌäπÏ†ú Îπµ', needCount: 10, reward: 'ÏÑ±Ïàò', rewardCount: 10 },
            { type: 'daily', location: 'Ìã∞Î•¥ÏΩîÎÑ§Ïùº', npc: 'ÌçºÍ±∞Ïä§', need: 'Í∞ïÏ≤†Í¥¥', needCount: 8, reward: 'Ìï©Í∏àÍ∞ïÍ¥¥', rewardCount: 4 },
            { type: 'daily', location: 'Ìã∞Î•¥ÏΩîÎÑ§Ïùº', npc: 'ÏºÄÏù¥Ìã¥', need: 'Ïö∞Ïú†', needCount: 10, reward: 'ÌäπÏ†ú Îπµ', rewardCount: 3 },
            { type: 'daily', location: 'Ìã∞Î•¥ÏΩîÎÑ§Ïùº', npc: 'Î©îÏù¥Î∏ê', need: 'ÌäπÏ†ú Îπµ', needCount: 1, reward: 'ÏÑ±Ïàò', rewardCount: 1 },
            { type: 'daily', location: 'ÎëêÍ∞àÎìú ÏïÑÏùº', npc: 'ÏóòÎπà', need: 'ÏïºÏ±Ñ Î≥∂Ïùå', needCount: 2, reward: 'ÏÉÅÍ∏â Î™©Ïû¨', rewardCount: 8 },
            { type: 'daily', location: 'ÎëêÍ∞àÎìú ÏïÑÏùº', npc: 'Ìä∏Î†àÏù¥Ïãú', need: 'ÌÜµÎÇòÎ¨¥', needCount: 10, reward: 'ÏÉùÍ∞ÄÏ£Ω', rewardCount: 10 },
            { type: 'daily', location: 'ÎëêÍ∞àÎìú ÏïÑÏùº', npc: 'Ìä∏Î†àÏù¥Ïãú', need: 'ÌÜµÎÇòÎ¨¥', needCount: 100, reward: 'ÏÉÅÍ∏â ÏÉùÍ∞ÄÏ£Ω', rewardCount: 10 },
            { type: 'daily', location: 'ÎçòÎ∞îÌäº', npc: 'ÎÑ§Î¶¨Ïä§', need: 'ÎèôÍ¥ëÏÑù', needCount: 10, reward: 'ÏÉÅÍ∏â ÏÉùÍ∞ÄÏ£Ω', rewardCount: 10 },
            { type: 'daily', location: 'ÎçòÎ∞îÌäº', npc: 'ÎÑ§Î¶¨Ïä§', need: 'Ìï©Í∏àÍ∞ïÍ¥¥', needCount: 8, reward: 'ÌäπÏàòÍ∞ïÍ¥¥', rewardCount: 4 },
            { type: 'daily', location: 'ÎçòÎ∞îÌäº', npc: 'Ï†úÏù¥ÎØ∏', need: 'ÏÇ¨Í≥º ÏÉùÌÅ¨Î¶º ÏºÄÏù¥ÌÅ¨', needCount: 1, reward: 'ÏÉÅÍ∏â Ïò∑Í∞ê+', rewardCount: 4 },
            { type: 'daily', location: 'ÎçòÎ∞îÌäº', npc: 'Ï†úÎ°¨', need: 'ÌÅ¨Î¶ºÏÜåÏä§ Ïä§ÌÖåÏù¥ÌÅ¨', needCount: 1, reward: 'ÏÉÅÍ∏â Ïã§ÌÅ¨+', rewardCount: 4 },
            { type: 'accountDaily', location: 'ÏºàÎùºÎ≤†Ïù¥Ïä§Ï∫†ÌîÑ', npc: 'Î°úÏõ¨', need: 'ÎßàÎÇò ÌÅ¨Î¶¨Ïä§ÌÉà', needCount: 5, reward: 'Í≤ΩÌóòÏπò Ìè¨ÏÖò', rewardCount: 1 },
            { type: 'accountWeekly', location: 'ÎçòÎ∞îÌäº', npc: 'Îç∏Î†å', need: 'Í≥†Í∏â ÏõêÎã®', needCount: 3, reward: 'ÎßàÎ≤ï Í∞ÄÎ£®', rewardCount: 10 }
        ];

        // ÌÄòÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï†ïÏùò (ÏùºÎ∞ò ÌÄòÏä§Ìä∏)
        let questManagementData = [
            { type: 'weekly', name: 'ÌïÑÎìúÎ≥¥Ïä§', count: 3, category: 'Ï†ÑÌà¨' },
            { type: 'weekly', name: 'Ïñ¥ÎπÑÏä§ ÎçòÏ†Ñ', count: 3, category: 'ÎçòÏ†Ñ' },
            { type: 'weekly', name: 'Î†àÏù¥Îìú', count: 2, category: 'Î†àÏù¥Îìú' },
            { type: 'daily', name: 'Í≤∞Í≥Ñ', count: 2, category: 'ÏùºÏùº' },
            { type: 'daily', name: 'Íµ¨Î©ç', count: 3, category: 'ÏùºÏùº' },
            { type: 'accountDaily', name: 'ÏùºÏùºÎ≥¥ÏÉÅ', count: 1, category: 'Í≥ÑÏ†ï' },
            { type: 'accountWeekly', name: 'Ï£ºÍ∞ÑÎØ∏ÏÖò', count: 7, category: 'Í≥ÑÏ†ï' }
        ];

        // Ïû¨Î£å Îç∞Ïù¥ÌÑ∞ Ï†ïÏùò
        let materialData = [
            { name: 'Í∞ïÏ≤†Í¥¥' },
            { name: 'ÏùÄÌï©Í∏àÍ¥¥' },
            { name: 'ÌÜµÎÇòÎ¨¥' },
            { name: 'ÏÉùÍ∞ÄÏ£Ω' }
        ];

        // Ïû¨Î£å Îç∞Ïù¥ÌÑ∞ Î°úÎìú/Ï†ÄÏû•
        function loadMaterialData() {
            const stored = localStorage.getItem('mabinogi_material_data');
            if (stored) {
                try {
                    const parsedData = JSON.parse(stored);
                    if (Array.isArray(parsedData) && parsedData.every(material => material.name)) {
                        materialData = parsedData;
                    } else {
                        console.warn('ÏûòÎ™ªÎêú Ïû¨Î£å Îç∞Ïù¥ÌÑ∞ ÌòïÏãù, Í∏∞Î≥∏Í∞íÏúºÎ°ú Î≥µÏõê');
                        materialData = [
                            { name: 'Í∞ïÏ≤†Í¥¥' },
                            { name: 'ÏùÄÌï©Í∏àÍ¥¥' },
                            { name: 'ÌÜµÎÇòÎ¨¥' },
                            { name: 'ÏÉùÍ∞ÄÏ£Ω' }
                        ];
                        saveMaterialData();
                    }
                } catch (error) {
                    console.error('Failed to load material data:', error);
                    saveMaterialData();
                }
            } else {
                saveMaterialData();
            }
            return materialData;
        }

        // Ïû¨Î£å Ï∂îÍ∞Ä
        function addMaterial() {
            const name = document.getElementById('materialName').value.trim();

            if (!name) {
                alert('Ïû¨Î£åÎ™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }

            if (materialData.some(material => material.name === name)) {
                alert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Ïû¨Î£åÏûÖÎãàÎã§!');
                return;
            }

            const currentEditIndex = document.getElementById('addMaterialBtn').getAttribute('data-edit-index');

            if (currentEditIndex !== null) {
                const index = parseInt(currentEditIndex);
                materialData[index] = { name };
                document.getElementById('addMaterialBtn').textContent = '‚ûï Ïû¨Î£å Ï∂îÍ∞Ä';
                document.getElementById('addMaterialBtn').removeAttribute('data-edit-index');
            } else {
                materialData.push({ name });
            }

            saveMaterialData();
            clearMaterialForm();
            renderMaterialList();
            debouncedUpdate();
        }

        // Ïû¨Î£å ÏàòÏ†ï/ÏÇ≠Ï†ú Ìï®Ïàò
        function editMaterial(index) {
            const material = materialData[index];
            document.getElementById('materialName').value = material.name;
            document.getElementById('addMaterialBtn').textContent = '‚úèÔ∏è Ïû¨Î£å ÏàòÏ†ï';
            document.getElementById('addMaterialBtn').setAttribute('data-edit-index', index);
            document.getElementById('materialName').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteMaterial(index) {
            const material = materialData[index];
            if (!confirm(`Ï†ïÎßê Ïù¥ Ïû¨Î£åÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n${material.name}`)) {
                return;
            }

            updateCharacterDataAfterMaterialDeletion(index);
            materialData.splice(index, 1);
            saveMaterialData();
            renderMaterialList();
            debouncedUpdate();
        }

        function clearMaterialForm() {
            document.getElementById('materialName').value = '';
            const btn = document.getElementById('addMaterialBtn');
            btn.textContent = '‚ûï Ïû¨Î£å Ï∂îÍ∞Ä';
            btn.removeAttribute('data-edit-index');
        }

        // Ïû¨Î£å Î™©Î°ù Î†åÎçîÎßÅ
        function renderMaterialList() {
            const materialList = document.getElementById('materialList');

            if (materialData.length === 0) {
                materialList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">Îì±Î°ùÎêú Ïû¨Î£åÍ∞Ä ÏóÜÏäµÎãàÎã§</div>';
            } else {
                materialList.innerHTML = materialData.map((material, index) => `
            <div class="quest-item draggable-item" data-index="${index}">
                <div class="quest-info">
                    <span class="drag-handle" style="cursor: move; margin-right: 10px;">‚ãÆ‚ãÆ</span>
                    <span class="material-badge">Ïû¨Î£å</span>
                    <span><strong>${material.name}</strong></span>
                </div>
                <div class="quest-actions">
                    <button class="btn-small btn-edit" onclick="editMaterial(${index})" title="ÏàòÏ†ï">‚úèÔ∏è</button>
                    <button class="btn-small btn-delete" onclick="deleteMaterial(${index})" title="ÏÇ≠Ï†ú">üóëÔ∏è</button>
                </div>
            </div>
        `).join('');
            }

            setTimeout(() => {
                enableDragAndDrop('#materialList', materialData, saveMaterialData, renderMaterialList)();
            }, 0);
        }

        function saveMaterialData() {
            try {
                localStorage.setItem('mabinogi_material_data', JSON.stringify(materialData));
                showSaveStatus();
                return true;
            } catch (error) {
                console.error('Material data save failed:', error);
                showSaveStatus(true);
                return false;
            }
        }

        function checkAccountDataReset() {
            const currentDaily = getCurrentLogicDate();
            const currentWeekly = getCurrentWeekStart();

            // Í≥ÑÏ†ï ÏùºÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Ï≤¥ÌÅ¨
            const lastAccountDaily = localStorage.getItem('mabinogi_account_daily_reset') || '';
            if (lastAccountDaily !== currentDaily) {
                console.log('Í≥ÑÏ†ï ÏùºÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî:', lastAccountDaily, '->', currentDaily);
                localStorage.removeItem('mabinogi_account_daily_quest');
                localStorage.removeItem('mabinogi_account_daily_questManagement');
                localStorage.setItem('mabinogi_account_daily_reset', currentDaily);
            }

            // Í≥ÑÏ†ï Ï£ºÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Ï≤¥ÌÅ¨
            const lastAccountWeekly = localStorage.getItem('mabinogi_account_weekly_reset') || '';
            if (lastAccountWeekly !== currentWeekly) {
                console.log('Í≥ÑÏ†ï Ï£ºÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî:', lastAccountWeekly, '->', currentWeekly);
                localStorage.removeItem('mabinogi_account_weekly_quest');
                localStorage.removeItem('mabinogi_account_weekly_questManagement');
                localStorage.setItem('mabinogi_account_weekly_reset', currentWeekly);
            }
        }

        // Î¨ºÎ¨ºÍµêÌôò Îç∞Ïù¥ÌÑ∞ Î°úÎìú/Ï†ÄÏû•
        function loadQuestData() {
            const stored = localStorage.getItem('mabinogi_quest_data');
            if (stored) {
                try {
                    const parsedData = JSON.parse(stored);
                    if (Array.isArray(parsedData) && parsedData.every(quest =>
                        quest.type && quest.location && quest.npc && quest.need && quest.reward)) {
                        questData = parsedData;
                    }
                } catch (error) {
                    console.error('Failed to load quest data:', error);
                    saveQuestData();
                }
            } else {
                saveQuestData();
            }
            return questData;
        }

        function saveQuestData() {
            try {
                localStorage.setItem('mabinogi_quest_data', JSON.stringify(questData));
                showSaveStatus();
                return true;
            } catch (error) {
                console.error('Quest data save failed:', error);
                showSaveStatus(true);
                return false;
            }
        }

        // ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨ Îç∞Ïù¥ÌÑ∞ Î°úÎìú/Ï†ÄÏû•
        function loadQuestManagementData() {
            const stored = localStorage.getItem('mabinogi_quest_management_data');
            if (stored) {
                try {
                    const parsedData = JSON.parse(stored);
                    if (Array.isArray(parsedData) && parsedData.every(quest =>
                        quest.type && quest.name && quest.count)) {
                        questManagementData = parsedData;
                    }
                } catch (error) {
                    console.error('Failed to load quest management data:', error);
                    saveQuestManagementData();
                }
            } else {
                saveQuestManagementData();
            }
            return questManagementData;
        }

        function saveQuestManagementData() {
            try {
                localStorage.setItem('mabinogi_quest_management_data', JSON.stringify(questManagementData));
                showSaveStatus();
                return true;
            } catch (error) {
                console.error('Quest management data save failed:', error);
                showSaveStatus(true);
                return false;
            }
        }

        // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ Í∏∞Îä•
        function enableDragAndDrop(containerSelector, dataArray, saveFunction, renderFunction) {
            let draggedElement = null;
            let draggedIndex = null;

            function setupDragEvents() {
                const container = document.querySelector(containerSelector);
                if (!container) return;

                const items = container.querySelectorAll('.draggable-item');

                items.forEach((item, index) => {
                    item.draggable = true;
                    item.style.cursor = 'move';

                    item.addEventListener('dragstart', (e) => {
                        draggedElement = item;
                        draggedIndex = index;
                        item.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                        console.log(`ÎìúÎûòÍ∑∏ ÏãúÏûë: Ïù∏Îç±Ïä§ ${index}`);
                    });

                    item.addEventListener('dragend', (e) => {
                        item.classList.remove('dragging');
                        draggedElement = null;
                        draggedIndex = null;
                        console.log('ÎìúÎûòÍ∑∏ Ï¢ÖÎ£å');
                    });

                    item.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                    });

                    item.addEventListener('drop', (e) => {
                        e.preventDefault();
                        if (draggedElement && draggedElement !== item) {
                            const targetIndex = Array.from(items).indexOf(item);
                            console.log(`ÎìúÎ°≠: ${draggedIndex} -> ${targetIndex}`);

                            // Îç∞Ïù¥ÌÑ∞ ÌÉÄÏûÖ Í≤∞Ï†ï
                            let dataType;
                            if (containerSelector.includes('questList')) {
                                dataType = 'quest';
                            } else if (containerSelector.includes('questMgmtList')) {
                                dataType = 'questManagement';
                            } else if (containerSelector.includes('materialList')) {
                                dataType = 'material';
                            }

                            // Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Ïù∏Îç±Ïä§ ÏóÖÎç∞Ïù¥Ìä∏ (ÏàúÏÑú Î≥ÄÍ≤Ω Ï†ÑÏóê Ïã§Ìñâ)
                            if (dataType === 'material') {
                                updateCharacterDataIndicesAfterMaterialReorder(draggedIndex, targetIndex);
                            } else {
                                updateCharacterDataIndicesAfterReorder(draggedIndex, targetIndex, dataType);
                            }

                            // Î∞∞Ïó¥ ÏàúÏÑú Î≥ÄÍ≤Ω
                            const movedItem = dataArray.splice(draggedIndex, 1)[0];
                            dataArray.splice(targetIndex, 0, movedItem);

                            // Ï†ÄÏû• Î∞è Î†åÎçîÎßÅ
                            saveFunction();

                            setTimeout(() => {
                                renderFunction();
                                debouncedUpdate();
                            }, 50);
                        }
                    });
                });
            }

            return setupDragEvents;
        }

        function validateCharacterData(charId) {
            const data = loadCharacterData(charId);
            let hasChanges = false;

            // Î¨ºÎ¨ºÍµêÌôò Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù
            const validDailyChecks = {};
            const validWeeklyChecks = {};

            Object.entries(data.dailyChecks || {}).forEach(([key, value]) => {
                const idx = parseInt(key);
                if (idx >= 0 && idx < questData.length && questData[idx] && questData[idx].type === 'daily') {
                    validDailyChecks[idx] = value;
                } else {
                    hasChanges = true;
                    console.log(`ÏûòÎ™ªÎêú ÏùºÍ∞Ñ Ï≤¥ÌÅ¨ Îç∞Ïù¥ÌÑ∞ Ï†úÍ±∞: ${key}`);
                }
            });

            Object.entries(data.weeklyChecks || {}).forEach(([key, value]) => {
                const idx = parseInt(key);
                if (idx >= 0 && idx < questData.length && questData[idx] && questData[idx].type === 'weekly') {
                    validWeeklyChecks[idx] = value;
                } else {
                    hasChanges = true;
                    console.log(`ÏûòÎ™ªÎêú Ï£ºÍ∞Ñ Ï≤¥ÌÅ¨ Îç∞Ïù¥ÌÑ∞ Ï†úÍ±∞: ${key}`);
                }
            });

            // ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨ Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù
            const validDailyQuestMgmt = {};
            const validWeeklyQuestMgmt = {};

            Object.entries(data.dailyQuestMgmtChecks || {}).forEach(([key, value]) => {
                const idx = parseInt(key);
                if (idx >= 0 && idx < questManagementData.length && questManagementData[idx] && questManagementData[idx].type === 'daily') {
                    validDailyQuestMgmt[idx] = value;
                } else {
                    hasChanges = true;
                    console.log(`ÏûòÎ™ªÎêú ÏùºÍ∞Ñ ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨ Îç∞Ïù¥ÌÑ∞ Ï†úÍ±∞: ${key}`);
                }
            });

            Object.entries(data.weeklyQuestMgmtChecks || {}).forEach(([key, value]) => {
                const idx = parseInt(key);
                if (idx >= 0 && idx < questManagementData.length && questManagementData[idx] && questManagementData[idx].type === 'weekly') {
                    validWeeklyQuestMgmt[idx] = value;
                } else {
                    hasChanges = true;
                    console.log(`ÏûòÎ™ªÎêú Ï£ºÍ∞Ñ ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨ Îç∞Ïù¥ÌÑ∞ Ï†úÍ±∞: ${key}`);
                }
            });

            if (hasChanges) {
                data.dailyChecks = validDailyChecks;
                data.weeklyChecks = validWeeklyChecks;
                data.dailyQuestMgmtChecks = validDailyQuestMgmt;
                data.weeklyQuestMgmtChecks = validWeeklyQuestMgmt;
                saveCharacterData(charId, data);
                console.log(`${charId} Îç∞Ïù¥ÌÑ∞ Î¨¥Í≤∞ÏÑ± Î≥µÍµ¨ ÏôÑÎ£å`);
            }

            return data;
        }

        function validateAllCharacterData() {
            const characters = getCharacterList();
            let totalFixed = 0;

            characters.forEach(char => {
                const beforeData = JSON.stringify(loadCharacterData(char.id));
                validateCharacterData(char.id);
                const afterData = JSON.stringify(loadCharacterData(char.id));

                if (beforeData !== afterData) {
                    totalFixed++;
                    console.log(`${char.name} Îç∞Ïù¥ÌÑ∞ Î¨¥Í≤∞ÏÑ± ÏàòÏ†ïÎê®`);
                }
            });

            if (totalFixed > 0) {
                console.log(`Ï¥ù ${totalFixed}Í∞ú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏàòÏ†ïÎê®`);
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                setTimeout(() => {
                    renderAllCharacters();
                    updateStats();
                }, 100);
            }

            return totalFixed;
        }

        // Ïû¨Î£å ÏàúÏÑú Î≥ÄÍ≤Ω Ïãú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Ïù∏Îç±Ïä§ ÏóÖÎç∞Ïù¥Ìä∏
        function updateCharacterDataIndicesAfterMaterialReorder(oldIndex, newIndex) {
            console.log(`Ïû¨Î£å ÏàúÏÑú Î≥ÄÍ≤Ω: ${oldIndex} -> ${newIndex}`);

            if (oldIndex === newIndex) return;

            const characters = getCharacterList();
            const totalLength = materialData.length;
            const isMovingDown = oldIndex < newIndex;

            characters.forEach(char => {
                const data = loadCharacterData(char.id);

                if (!data.materialCounts) return;

                const newMaterialCounts = {};

                Object.entries(data.materialCounts).forEach(([indexStr, value]) => {
                    const currentIndex = parseInt(indexStr);
                    let newMappedIndex = currentIndex;

                    if (currentIndex === oldIndex) {
                        newMappedIndex = newIndex;
                    } else if (isMovingDown) {
                        if (currentIndex > oldIndex && currentIndex <= newIndex) {
                            newMappedIndex = currentIndex - 1;
                        }
                    } else {
                        if (currentIndex >= newIndex && currentIndex < oldIndex) {
                            newMappedIndex = currentIndex + 1;
                        }
                    }

                    if (newMappedIndex >= 0 && newMappedIndex < totalLength) {
                        newMaterialCounts[newMappedIndex] = value;
                    }
                });

                data.materialCounts = newMaterialCounts;
                saveCharacterData(char.id, data);
            });

            console.log('Ïû¨Î£å ÏàúÏÑú Î≥ÄÍ≤Ω ÌõÑ Ïù∏Îç±Ïä§ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
        }

        // Ïû¨Î£å ÏÇ≠Ï†ú Ïãú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
        function updateCharacterDataAfterMaterialDeletion(deletedIndex) {
            const characters = getCharacterList();
            characters.forEach(char => {
                const data = loadCharacterData(char.id);

                if (data.materialCounts) {
                    const newMaterialCounts = {};
                    Object.keys(data.materialCounts).forEach(key => {
                        const idx = parseInt(key);
                        if (idx < deletedIndex) {
                            newMaterialCounts[idx] = data.materialCounts[key];
                        } else if (idx > deletedIndex) {
                            newMaterialCounts[idx - 1] = data.materialCounts[key];
                        }
                    });
                    data.materialCounts = newMaterialCounts;
                    saveCharacterData(char.id, data);
                }
            });
        }

        // ÏàúÏÑú Î≥ÄÍ≤Ω Ïãú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Ïù∏Îç±Ïä§ ÏóÖÎç∞Ïù¥Ìä∏
        function updateCharacterDataIndicesAfterReorder(oldIndex, newIndex, dataType) {
            console.log(`ÏàúÏÑú Î≥ÄÍ≤Ω: ${dataType}, ${oldIndex} -> ${newIndex}`);

            if (oldIndex === newIndex) return; // Í∞ôÏùÄ ÏúÑÏπòÎ©¥ Ï≤òÎ¶¨ ÏïàÌï®

            const characters = getCharacterList();
            const totalLength = dataType === 'quest' ? questData.length : questManagementData.length;

            // Ïù¥Îèô Î∞©Ìñ• Í≤∞Ï†ï
            const isMovingDown = oldIndex < newIndex;

            // Îç∞Ïù¥ÌÑ∞ ÌÉÄÏûÖÏóê Îî∞Î•∏ ÌÇ§ Í≤∞Ï†ï
            let dailyKey, weeklyKey, accountDailyKey, accountWeeklyKey;

            if (dataType === 'quest') {
                dailyKey = 'dailyChecks';
                weeklyKey = 'weeklyChecks';
                accountDailyKey = 'mabinogi_account_daily_quest';
                accountWeeklyKey = 'mabinogi_account_weekly_quest';
            } else {
                dailyKey = 'dailyQuestMgmtChecks';
                weeklyKey = 'weeklyQuestMgmtChecks';
                accountDailyKey = 'mabinogi_account_daily_questManagement';
                accountWeeklyKey = 'mabinogi_account_weekly_questManagement';
            }

            characters.forEach(char => {
                const data = loadCharacterData(char.id);

                // Í∞Å Ï≤¥ÌÅ¨ ÌÉÄÏûÖÎ≥ÑÎ°ú Ï≤òÎ¶¨
                [dailyKey, weeklyKey].forEach(key => {
                    if (!data[key]) return;

                    const newData = {};

                    Object.entries(data[key]).forEach(([indexStr, value]) => {
                        const currentIndex = parseInt(indexStr);
                        let newMappedIndex = currentIndex;

                        if (currentIndex === oldIndex) {
                            // Ïù¥ÎèôÎêòÎäî ÏïÑÏù¥ÌÖú
                            newMappedIndex = newIndex;
                        } else if (isMovingDown) {
                            // ÏïÑÎûòÎ°ú Ïù¥Îèô: oldIndex+1 ~ newIndex Î≤îÏúÑÏùò ÏïÑÏù¥ÌÖúÎì§ÏùÑ ÏúÑÎ°ú Ìïú Ïπ∏
                            if (currentIndex > oldIndex && currentIndex <= newIndex) {
                                newMappedIndex = currentIndex - 1;
                            }
                        } else {
                            // ÏúÑÎ°ú Ïù¥Îèô: newIndex ~ oldIndex-1 Î≤îÏúÑÏùò ÏïÑÏù¥ÌÖúÎì§ÏùÑ ÏïÑÎûòÎ°ú Ìïú Ïπ∏
                            if (currentIndex >= newIndex && currentIndex < oldIndex) {
                                newMappedIndex = currentIndex + 1;
                            }
                        }

                        // Ïú†Ìö®Ìïú Î≤îÏúÑ ÌôïÏù∏
                        if (newMappedIndex >= 0 && newMappedIndex < totalLength) {
                            newData[newMappedIndex] = value;
                        }
                    });

                    data[key] = newData;
                });

                saveCharacterData(char.id, data);
            });

            // Í≥ÑÏ†ï Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
            [accountDailyKey, accountWeeklyKey].forEach(accountKey => {
                const accountData = JSON.parse(localStorage.getItem(accountKey) || '{}');
                const newAccountData = {};

                Object.entries(accountData).forEach(([indexStr, value]) => {
                    const currentIndex = parseInt(indexStr);
                    let newMappedIndex = currentIndex;

                    if (currentIndex === oldIndex) {
                        newMappedIndex = newIndex;
                    } else if (isMovingDown) {
                        if (currentIndex > oldIndex && currentIndex <= newIndex) {
                            newMappedIndex = currentIndex - 1;
                        }
                    } else {
                        if (currentIndex >= newIndex && currentIndex < oldIndex) {
                            newMappedIndex = currentIndex + 1;
                        }
                    }

                    if (newMappedIndex >= 0 && newMappedIndex < totalLength) {
                        newAccountData[newMappedIndex] = value;
                    }
                });

                localStorage.setItem(accountKey, JSON.stringify(newAccountData));
            });

            console.log('ÏàúÏÑú Î≥ÄÍ≤Ω ÌõÑ Ïù∏Îç±Ïä§ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
        }

        // ÏàúÏÑú Î≥ÄÍ≤Ω ÌõÑ Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
        function updateAllCharacterDataAfterReorder() {
            const characters = getCharacterList();

            setTimeout(() => {
                renderAllCharacters();
                updateFiltersAndUI();
            }, 0);
        }

        // Î¨ºÎ¨ºÍµêÌôò ÌÄòÏä§Ìä∏ Ï∂îÍ∞Ä
        function addQuest() {
            const type = document.getElementById('questType').value;
            const location = document.getElementById('questLocation').value.trim();
            const npc = document.getElementById('questNpc').value.trim();
            const need = document.getElementById('questNeed').value.trim();
            const needCount = parseInt(document.getElementById('questNeedCount').value);
            const reward = document.getElementById('questReward').value.trim();
            const rewardCount = parseInt(document.getElementById('questRewardCount').value);

            if (!location || !npc || !need || !needCount || !reward || !rewardCount) {
                alert('Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }

            if (needCount < 1 || rewardCount < 1) {
                alert('ÏàòÎüâÏùÄ 1 Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§!');
                return;
            }

            const currentEditIndex = document.getElementById('addQuestBtn').getAttribute('data-edit-index');

            if (currentEditIndex !== null) {
                const index = parseInt(currentEditIndex);
                questData[index] = { type, location, npc, need, needCount, reward, rewardCount };
                document.getElementById('addQuestBtn').textContent = '‚ûï ÌÄòÏä§Ìä∏ Ï∂îÍ∞Ä';
                document.getElementById('addQuestBtn').removeAttribute('data-edit-index');
            } else {
                questData.push({ type, location, npc, need, needCount, reward, rewardCount });
            }

            saveQuestData();
            clearQuestForm();
            renderQuestList();
            debouncedUpdate();
        }

        // ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨ Ï∂îÍ∞Ä
        function addQuestManagement() {
            const type = document.getElementById('questMgmtType').value;
            const name = document.getElementById('questMgmtName').value.trim();
            const count = parseInt(document.getElementById('questMgmtCount').value);
            const category = document.getElementById('questMgmtCategory').value.trim();

            if (!name || !count || !category) {
                alert('Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }

            if (count < 1) {
                alert('ÌöüÏàòÎäî 1 Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§!');
                return;
            }

            const currentEditIndex = document.getElementById('addQuestMgmtBtn').getAttribute('data-edit-index');

            if (currentEditIndex !== null) {
                const index = parseInt(currentEditIndex);
                questManagementData[index] = { type, name, count, category };
                document.getElementById('addQuestMgmtBtn').textContent = '‚ûï ÌÄòÏä§Ìä∏ Ï∂îÍ∞Ä';
                document.getElementById('addQuestMgmtBtn').removeAttribute('data-edit-index');
            } else {
                questManagementData.push({ type, name, count, category });
            }

            saveQuestManagementData();
            clearQuestManagementForm();
            renderQuestManagementList();
            debouncedUpdate();
        }

        // Î¨ºÎ¨ºÍµêÌôò ÌÄòÏä§Ìä∏ ÏàòÏ†ï
        function editQuest(index) {
            const quest = questData[index];

            document.getElementById('questType').value = quest.type;
            document.getElementById('questLocation').value = quest.location;
            document.getElementById('questNpc').value = quest.npc;
            document.getElementById('questNeed').value = quest.need;
            document.getElementById('questNeedCount').value = quest.needCount;
            document.getElementById('questReward').value = quest.reward;
            document.getElementById('questRewardCount').value = quest.rewardCount;

            document.getElementById('addQuestBtn').textContent = '‚úèÔ∏è ÌÄòÏä§Ìä∏ ÏàòÏ†ï';
            document.getElementById('addQuestBtn').setAttribute('data-edit-index', index);

            document.getElementById('questType').scrollIntoView({ behavior: 'smooth' });
        }

        // ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨ ÏàòÏ†ï
        function editQuestManagement(index) {
            const quest = questManagementData[index];

            document.getElementById('questMgmtType').value = quest.type;
            document.getElementById('questMgmtName').value = quest.name;
            document.getElementById('questMgmtCount').value = quest.count;
            document.getElementById('questMgmtCategory').value = quest.category;

            document.getElementById('addQuestMgmtBtn').textContent = '‚úèÔ∏è ÌÄòÏä§Ìä∏ ÏàòÏ†ï';
            document.getElementById('addQuestMgmtBtn').setAttribute('data-edit-index', index);

            document.getElementById('questMgmtType').scrollIntoView({ behavior: 'smooth' });
        }

        // Î¨ºÎ¨ºÍµêÌôò ÌÄòÏä§Ìä∏ ÏÇ≠Ï†ú
        function deleteQuest(index) {
            const quest = questData[index];
            if (!quest) {
                console.error(`ÏûòÎ™ªÎêú ÌÄòÏä§Ìä∏ Ïù∏Îç±Ïä§: ${index}`);
                return;
            }

            if (!confirm(`Ï†ïÎßê Ïù¥ ÌÄòÏä§Ìä∏Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n${quest.location} - ${quest.npc}: ${quest.need} ${quest.needCount}Í∞ú`)) {
                return;
            }

            // Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ Ï†ÑÏóê Î°úÍπÖ
            console.log('ÌÄòÏä§Ìä∏ ÏÇ≠Ï†ú ÏãúÏûë:', index, quest.location);

            updateCharacterDataAfterDeletion(index, 'quest');
            questData.splice(index, 1);
            saveQuestData();
            renderQuestList();

            // Ï∂©Î∂ÑÌïú ÏßÄÏó∞ ÌõÑ UI ÏóÖÎç∞Ïù¥Ìä∏
            setTimeout(() => {
                renderAllCharacters();
                updateFiltersAndUI();
            }, 100);
        }

        // ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨ ÏÇ≠Ï†ú
        function deleteQuestManagement(index) {
            const quest = questManagementData[index];
            if (!quest) {
                console.error(`ÏûòÎ™ªÎêú ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨ Ïù∏Îç±Ïä§: ${index}`);
                return;
            }

            if (!confirm(`Ï†ïÎßê Ïù¥ ÌÄòÏä§Ìä∏Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n${quest.name} (${quest.count}Ìöå)`)) {
                return;
            }

            // Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ Ï†ÑÏóê Î°úÍπÖ
            console.log('ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨ ÏÇ≠Ï†ú ÏãúÏûë:', index, quest.name);

            updateCharacterDataAfterDeletion(index, 'questManagement');
            questManagementData.splice(index, 1);
            saveQuestManagementData();
            renderQuestManagementList();

            // Ï∂©Î∂ÑÌïú ÏßÄÏó∞ ÌõÑ UI ÏóÖÎç∞Ïù¥Ìä∏
            setTimeout(() => {
                renderAllCharacters();
                updateFiltersAndUI();
            }, 100);
        }

        // ÏÇ≠Ï†ú ÌõÑ Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
        function updateCharacterDataAfterDeletion(deletedIndex, dataType) {
            console.log(`ÏÇ≠Ï†ú ÏãúÏûë: ${dataType}, Ïù∏Îç±Ïä§: ${deletedIndex}`);

            const characters = getCharacterList();
            // ÏÇ≠Ï†ú ÌõÑÏùò Í∏∏Ïù¥Î°ú Í≥ÑÏÇ∞
            const totalLength = (dataType === 'quest' ? questData.length : questManagementData.length) - 1;

            // ÏÇ≠Ï†ú Ï†Ñ Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ (ÎîîÎ≤ÑÍπÖÏö©)
            const backupData = {};

            characters.forEach(char => {
                const data = loadCharacterData(char.id);

                // Î∞±ÏóÖ ÏÉùÏÑ±
                backupData[char.id] = JSON.parse(JSON.stringify(data));

                const dailyKey = dataType === 'quest' ? 'dailyChecks' : 'dailyQuestMgmtChecks';
                const weeklyKey = dataType === 'quest' ? 'weeklyChecks' : 'weeklyQuestMgmtChecks';

                // ÏÉàÎ°úÏö¥ Ï≤¥ÌÅ¨ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                const newDailyChecks = {};
                const newWeeklyChecks = {};

                // dailyChecks Ïû¨Íµ¨ÏÑ±
                Object.entries(data[dailyKey] || {}).forEach(([key, value]) => {
                    const idx = parseInt(key);

                    // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ Ï∂îÍ∞Ä
                    if (isNaN(idx) || idx < 0) return;

                    if (idx < deletedIndex) {
                        // ÏÇ≠Ï†úÎêú Ïù∏Îç±Ïä§Î≥¥Îã§ ÏûëÏùÄ Í≤ΩÏö∞ Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ
                        newDailyChecks[idx] = value;
                    } else if (idx > deletedIndex) {
                        // ÏÇ≠Ï†úÎêú Ïù∏Îç±Ïä§Î≥¥Îã§ ÌÅ∞ Í≤ΩÏö∞ 1Ïî© Í∞êÏÜå
                        const newIdx = idx - 1;
                        // ÏÇ≠Ï†ú ÌõÑ Î∞∞Ïó¥ Í∏∏Ïù¥Î°ú Í≤ÄÏ¶ù
                        if (newIdx >= 0 && newIdx <= totalLength) {
                            newDailyChecks[newIdx] = value;
                        }
                    }
                });

                // weeklyChecks Ïû¨Íµ¨ÏÑ±
                Object.entries(data[weeklyKey] || {}).forEach(([key, value]) => {
                    const idx = parseInt(key);

                    if (isNaN(idx) || idx < 0) return;

                    if (idx < deletedIndex) {
                        newWeeklyChecks[idx] = value;
                    } else if (idx > deletedIndex) {
                        const newIdx = idx - 1;
                        if (newIdx >= 0 && newIdx <= totalLength) {
                            newWeeklyChecks[newIdx] = value;
                        }
                    }
                });

                // Í≥ÑÏ†ï Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
                const accountDailyKey = `mabinogi_account_daily_${dataType}`;
                const accountWeeklyKey = `mabinogi_account_weekly_${dataType}`;

                [accountDailyKey, accountWeeklyKey].forEach(accountKey => {
                    const accountData = JSON.parse(localStorage.getItem(accountKey) || '{}');
                    const newAccountData = {};

                    Object.entries(accountData).forEach(([key, value]) => {
                        const idx = parseInt(key);

                        if (isNaN(idx) || idx < 0) return;

                        if (idx < deletedIndex) {
                            newAccountData[idx] = value;
                        } else if (idx > deletedIndex) {
                            const newIdx = idx - 1;
                            if (newIdx >= 0 && newIdx <= totalLength) {
                                newAccountData[newIdx] = value;
                            }
                        }
                    });

                    localStorage.setItem(accountKey, JSON.stringify(newAccountData));
                });

                // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                data[dailyKey] = newDailyChecks;
                data[weeklyKey] = newWeeklyChecks;
                saveCharacterData(char.id, data);

                console.log(`Ï∫êÎ¶≠ÌÑ∞ ${char.name} Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å`);
            });

            console.log('ÏÇ≠Ï†ú ÌõÑ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
        }

        // Ìèº Ï¥àÍ∏∞Ìôî
        function clearQuestForm() {
            document.getElementById('questType').value = 'daily';
            document.getElementById('questLocation').value = '';
            document.getElementById('questNpc').value = '';
            document.getElementById('questNeed').value = '';
            document.getElementById('questNeedCount').value = '';
            document.getElementById('questReward').value = '';
            document.getElementById('questRewardCount').value = '';

            const btn = document.getElementById('addQuestBtn');
            btn.textContent = '‚ûï ÌÄòÏä§Ìä∏ Ï∂îÍ∞Ä';
            btn.removeAttribute('data-edit-index');
        }

        function clearQuestManagementForm() {
            document.getElementById('questMgmtType').value = 'daily';
            document.getElementById('questMgmtName').value = '';
            document.getElementById('questMgmtCount').value = '';
            document.getElementById('questMgmtCategory').value = '';

            const btn = document.getElementById('addQuestMgmtBtn');
            btn.textContent = '‚ûï ÌÄòÏä§Ìä∏ Ï∂îÍ∞Ä';
            btn.removeAttribute('data-edit-index');
        }

        // Î¨ºÎ¨ºÍµêÌôò ÌÄòÏä§Ìä∏ Î™©Î°ù Î†åÎçîÎßÅ
        function renderQuestList() {
            const questList = document.getElementById('questList');

            if (questData.length === 0) {
                questList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">Îì±Î°ùÎêú ÌÄòÏä§Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§</div>';
            } else {
                questList.innerHTML = questData.map((quest, index) => {
                    const badgeClass = quest.type === 'weekly' ? 'weekly-badge' :
                        quest.type === 'accountDaily' ? 'account-daily-badge' :
                            quest.type === 'accountWeekly' ? 'account-weekly-badge' : 'daily-badge';
                    const badgeText = quest.type === 'weekly' ? 'Ï£ºÍ∞Ñ' :
                        quest.type === 'accountDaily' ? 'Í≥ÑÏ†ïÏùºÍ∞Ñ' :
                            quest.type === 'accountWeekly' ? 'Í≥ÑÏ†ïÏ£ºÍ∞Ñ' : 'ÏùºÍ∞Ñ';

                    return `
                <div class="quest-item draggable-item" data-index="${index}">
                    <div class="quest-info">
                        <span class="drag-handle" style="cursor: move; margin-right: 10px;">‚ãÆ‚ãÆ</span>
                        <span class="${badgeClass}">${badgeText}</span>
                        <span><strong>${quest.location}</strong> - ${quest.npc}</span>
                        <span>${quest.need} ${quest.needCount}Í∞ú ‚Üí ${quest.reward} ${quest.rewardCount}Í∞ú</span>
                    </div>
                    <div class="quest-actions">
                        <button class="btn-small btn-edit" onclick="editQuest(${index})" title="ÏàòÏ†ï">‚úèÔ∏è</button>
                        <button class="btn-small btn-delete" onclick="deleteQuest(${index})" title="ÏÇ≠Ï†ú">üóëÔ∏è</button>
                    </div>
                </div>
            `;
                }).join('');
            }

            setTimeout(() => {
                enableDragAndDrop('#questList', questData, saveQuestData, renderQuestList)();
            }, 0);
        }

        // ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨ Î™©Î°ù Î†åÎçîÎßÅ
        function renderQuestManagementList() {
            const questMgmtList = document.getElementById('questMgmtList');

            if (questManagementData.length === 0) {
                questMgmtList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">Îì±Î°ùÎêú ÌÄòÏä§Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§</div>';
            } else {
                questMgmtList.innerHTML = questManagementData.map((quest, index) => {
                    const badgeClass = quest.type === 'weekly' ? 'weekly-badge' :
                        quest.type === 'accountDaily' ? 'account-daily-badge' :
                            quest.type === 'accountWeekly' ? 'account-weekly-badge' : 'daily-badge';
                    const badgeText = quest.type === 'weekly' ? 'Ï£ºÍ∞Ñ' :
                        quest.type === 'accountDaily' ? 'Í≥ÑÏ†ïÏùºÍ∞Ñ' :
                            quest.type === 'accountWeekly' ? 'Í≥ÑÏ†ïÏ£ºÍ∞Ñ' : 'ÏùºÍ∞Ñ';

                    return `
                <div class="quest-item draggable-item" data-index="${index}">
                    <div class="quest-info">
                        <span class="drag-handle" style="cursor: move; margin-right: 10px;">‚ãÆ‚ãÆ</span>
                        <span class="${badgeClass}">${badgeText}</span>
                        <span><strong>${quest.category}</strong></span>
                        <span>${quest.name} ${quest.count}Ìöå</span>
                    </div>
                    <div class="quest-actions">
                        <button class="btn-small btn-edit" onclick="editQuestManagement(${index})" title="ÏàòÏ†ï">‚úèÔ∏è</button>
                        <button class="btn-small btn-delete" onclick="deleteQuestManagement(${index})" title="ÏÇ≠Ï†ú">üóëÔ∏è</button>
                    </div>
                </div>
            `;
                }).join('');
            }

            setTimeout(() => {
                enableDragAndDrop('#questMgmtList', questManagementData, saveQuestManagementData, renderQuestManagementList)();
            }, 0);
        }

        // Í≥ÑÏ†ï Í≥µÏú† Ï≤¥ÌÅ¨ ÏÉÅÌÉú ÌôïÏù∏
        function isAccountChecked(questIndex, dataType = 'quest') {
            const currentData = dataType === 'quest' ? questData : questManagementData;
            const quest = currentData[questIndex];

            if (!quest || (quest.type !== 'accountDaily' && quest.type !== 'accountWeekly')) return false;

            const timeType = quest.type === 'accountDaily' ? 'daily' : 'weekly';
            const accountKey = `mabinogi_account_${timeType}_${dataType}`;
            const stored = localStorage.getItem(accountKey);
            const accountData = stored ? JSON.parse(stored) : {};

            return accountData[questIndex] || false;
        }

        // Í≥ÑÏ†ï Í≥µÏú† Ï≤¥ÌÅ¨ ÏÉÅÌÉú ÏÑ§Ï†ï
        function setAccountChecked(questIndex, checked, dataType = 'quest') {
            const currentData = dataType === 'quest' ? questData : questManagementData;
            const quest = currentData[questIndex];

            if (!quest || (quest.type !== 'accountDaily' && quest.type !== 'accountWeekly')) return;

            const timeType = quest.type === 'accountDaily' ? 'daily' : 'weekly';
            const accountKey = `mabinogi_account_${timeType}_${dataType}`;
            const stored = localStorage.getItem(accountKey);
            let accountData = stored ? JSON.parse(stored) : {};

            if (checked) {
                accountData[questIndex] = true;
            } else {
                delete accountData[questIndex];
            }

            // Ï†ÄÏû• ÌõÑ ÏÉÅÌÉú ÌôïÏù∏ Î°úÍ∑∏ Ï∂îÍ∞Ä (ÎîîÎ≤ÑÍπÖÏö©)
            localStorage.setItem(accountKey, JSON.stringify(accountData));
            console.log(`Í≥ÑÏ†ï Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•: ${accountKey}`, accountData);

            // Î™®Îì† Ï∫êÎ¶≠ÌÑ∞Ïùò UI ÏóÖÎç∞Ïù¥Ìä∏
            const characters = getCharacterList();
            characters.forEach(char => {
                document.querySelectorAll(`tr[data-char='${char.id}'][data-row='${questIndex}'][data-type='${dataType}']`).forEach(row => {
                    const checkbox = row.querySelector('.checker');
                    if (checkbox) {
                        checkbox.checked = checked;
                        row.classList.toggle('completed', checked);
                    }
                });
                updateProgress(char.id);
            });

            // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            updateStats();

            // ÌïÑÌÑ∞Í∞Ä Ï†ÅÏö©Îêú ÏÉÅÌÉúÎùºÎ©¥ ÌÖåÏù¥Î∏îÏùÑ Îã§Ïãú Î†åÎçîÎßÅ
            const currentTab = getCurrentTab();
            if (currentTab === 'allView') {
                const statusFilter = document.getElementById('statusFilter')?.value;
                if (statusFilter && statusFilter !== 'all') {
                    setTimeout(() => {
                        renderAllCharacters();
                    }, 0);
                }
            }
        }

        // ÌòÑÏû¨ ÎÇ†Ïßú Í≥ÑÏÇ∞
        function getCurrentLogicDate() {
            const now = new Date();
            const logicDate = new Date(now);
            if (now.getHours() < 6) {
                logicDate.setDate(now.getDate() - 1);
            }
            return logicDate.toISOString().slice(0, 10);
        }

        function getCurrentWeekStart() {
            const now = new Date();
            let current = new Date(now);

            if (now.getHours() < 6) {
                current.setDate(current.getDate() - 1);
            }

            const dayOfWeek = current.getDay();
            const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;

            const monday = new Date(current);
            monday.setDate(current.getDate() + daysToMonday);
            monday.setHours(6, 0, 0, 0);

            if (now < monday) {
                monday.setDate(monday.getDate() - 7);
            }

            return monday.toISOString().slice(0, 10);
        }

        // Î¶¨ÏÖã ÌÉÄÏù¥Î®∏ ÏóÖÎç∞Ïù¥Ìä∏
        function updateResetTimers() {
            const now = new Date();

            const nextDaily = new Date(now);
            nextDaily.setDate(now.getDate() + 1);
            nextDaily.setHours(6, 0, 0, 0);
            if (now.getHours() >= 6) {
                // Ïù¥ÎØ∏ Ïò§Îäò 6Ïãú ÏßÄÎÇ¨ÏúºÎ©¥ ÎÇ¥Ïùº 6Ïãú
            } else {
                nextDaily.setDate(now.getDate());
            }

            const nextWeekly = new Date(now);
            const currentDay = now.getDay();
            const daysUntilMonday = currentDay === 0 ? 1 : 8 - currentDay;
            nextWeekly.setDate(now.getDate() + daysUntilMonday);
            nextWeekly.setHours(6, 0, 0, 0);

            const thisWeekMonday = new Date(now);
            const daysToThisMonday = currentDay === 0 ? -6 : 1 - currentDay;
            thisWeekMonday.setDate(now.getDate() + daysToThisMonday);
            thisWeekMonday.setHours(6, 0, 0, 0);

            if (now < thisWeekMonday) {
                nextWeekly.setTime(thisWeekMonday.getTime());
            }

            const dailyDiff = nextDaily - now;
            const weeklyDiff = nextWeekly - now;

            function formatTime(ms) {
                const hours = Math.floor(ms / (1000 * 60 * 60));
                const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((ms % (1000 * 60)) / 1000);
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            function formatDaysTime(ms) {
                const days = Math.floor(ms / (1000 * 60 * 60 * 24));
                const hours = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((ms % (1000 * 60)) / 1000);
                return `${days}Ïùº ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            document.getElementById('dailyTimer').textContent = formatTime(dailyDiff);
            document.getElementById('weeklyTimer').textContent = formatDaysTime(weeklyDiff);
        }

        // Î∏åÎùºÏö∞Ï†Ä Ï†úÎ™© ÏóÖÎç∞Ïù¥Ìä∏
        function updatePageTitle() {
            const characters = getCharacterList();
            let totalIncomplete = 0;

            characters.forEach(char => {
                const data = loadCharacterData(char.id);

                const tradeIncomplete = questData.length - (Object.keys(data.dailyChecks || {}).length + Object.keys(data.weeklyChecks || {}).length);

                let questMgmtIncomplete = 0;
                questManagementData.forEach((quest, index) => {
                    const completedCount = getQuestMgmtCompletedCount(char.id, index);
                    questMgmtIncomplete += quest.count - completedCount;
                });

                totalIncomplete += tradeIncomplete + questMgmtIncomplete;
            });

            const baseTitle = 'Î™®ÎπÑ Ï∑ç';
            //document.getElementById('pageTitle').textContent = totalIncomplete > 0 ? `(${totalIncomplete}) ${baseTitle}` : baseTitle; //ÎØ∏ÏôÑÎ£å Í∞úÏàò
        }

        // Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù Í¥ÄÎ¶¨
        function getCharacterList() {
            const stored = localStorage.getItem('mabinogi_characters');
            return stored ? JSON.parse(stored) : [];
        }

        function saveCharacterList(characters) {
            localStorage.setItem('mabinogi_characters', JSON.stringify(characters));
            showSaveStatus();
        }

        function generateCharacterId() {
            return 'char_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Ï†ÄÏû• ÏÉÅÌÉú ÌëúÏãú
        function showSaveStatus(isError = false) {
            const status = document.getElementById('saveStatus');
            status.className = 'save-status show' + (isError ? ' error' : '');
            status.textContent = isError ? 'Ï†ÄÏû• Ïã§Ìå®!' : 'Ï†ÄÏû•Îê®';

            setTimeout(() => {
                status.classList.remove('show');
            }, 2000);
        }

        // Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞
        function exportData() {
            try {
                const characters = getCharacterList();
                const allData = {
                    characters: characters,
                    characterData: {},
                    questData: questData,
                    questManagementData: questManagementData,
                    // Í≥ÑÏ†ï Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
                    accountData: {
                        dailyQuest: JSON.parse(localStorage.getItem('mabinogi_account_daily_quest') || '{}'),
                        weeklyQuest: JSON.parse(localStorage.getItem('mabinogi_account_weekly_quest') || '{}'),
                        dailyQuestManagement: JSON.parse(localStorage.getItem('mabinogi_account_daily_questManagement') || '{}'),
                        weeklyQuestManagement: JSON.parse(localStorage.getItem('mabinogi_account_weekly_questManagement') || '{}'),
                        dailyReset: localStorage.getItem('mabinogi_account_daily_reset') || '',
                        weeklyReset: localStorage.getItem('mabinogi_account_weekly_reset') || ''
                    }
                };

                characters.forEach(char => {
                    allData.characterData[char.id] = JSON.parse(localStorage.getItem(`mabinogi_${char.id}`) || '{}');
                });

                const dataStr = JSON.stringify(allData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `mabinogi_checklist_backup_${new Date().toISOString().slice(0, 10)}.json`;
                link.click();

                showSaveStatus();
            } catch (error) {
                console.error('Export failed:', error);
                showSaveStatus(true);
            }
        }

        // Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const importedData = JSON.parse(e.target.result);

                    if (!importedData.characters || !importedData.characterData) {
                        throw new Error('Invalid data format');
                    }

                    if (!confirm('Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Î•º Î™®Îëê ÏßÄÏö∞Í≥† Í∞ÄÏ†∏Ïò® Îç∞Ïù¥ÌÑ∞Î°ú ÍµêÏ≤¥ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                        return;
                    }

                    // Í∏∞Ï°¥ Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
                    const existingChars = getCharacterList();
                    existingChars.forEach(char => {
                        localStorage.removeItem(`mabinogi_${char.id}`);
                    });

                    // Í∏∞Ï°¥ Í≥ÑÏ†ï Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
                    localStorage.removeItem('mabinogi_account_daily_quest');
                    localStorage.removeItem('mabinogi_account_weekly_quest');
                    localStorage.removeItem('mabinogi_account_daily_questManagement');
                    localStorage.removeItem('mabinogi_account_weekly_questManagement');
                    localStorage.removeItem('mabinogi_account_daily_reset');
                    localStorage.removeItem('mabinogi_account_weekly_reset');

                    // ÏÉà Îç∞Ïù¥ÌÑ∞ Î≥µÏõê
                    saveCharacterList(importedData.characters);
                    Object.keys(importedData.characterData).forEach(charId => {
                        localStorage.setItem(`mabinogi_${charId}`, JSON.stringify(importedData.characterData[charId]));
                    });

                    if (importedData.questData) {
                        questData = importedData.questData;
                        saveQuestData();
                    }

                    if (importedData.questManagementData) {
                        questManagementData = importedData.questManagementData;
                        saveQuestManagementData();
                    }

                    // Í≥ÑÏ†ï Îç∞Ïù¥ÌÑ∞ Î≥µÏõê
                    if (importedData.accountData) {
                        localStorage.setItem('mabinogi_account_daily_quest', JSON.stringify(importedData.accountData.dailyQuest || {}));
                        localStorage.setItem('mabinogi_account_weekly_quest', JSON.stringify(importedData.accountData.weeklyQuest || {}));
                        localStorage.setItem('mabinogi_account_daily_questManagement', JSON.stringify(importedData.accountData.dailyQuestManagement || {}));
                        localStorage.setItem('mabinogi_account_weekly_questManagement', JSON.stringify(importedData.accountData.weeklyQuestManagement || {}));

                        if (importedData.accountData.dailyReset) {
                            localStorage.setItem('mabinogi_account_daily_reset', importedData.accountData.dailyReset);
                        }
                        if (importedData.accountData.weeklyReset) {
                            localStorage.setItem('mabinogi_account_weekly_reset', importedData.accountData.weeklyReset);
                        }
                    }

                    renderTabs();
                    renderAllCharacters();
                    renderQuestList();
                    renderQuestManagementList();
                    updateStats();
                    switchToTab('allView');

                    showSaveStatus();

                } catch (error) {
                    console.error('Import failed:', error);
                    alert('ÌååÏùºÏùÑ Í∞ÄÏ†∏Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§. Ïò¨Î∞îÎ•∏ Î∞±ÏóÖ ÌååÏùºÏù∏ÏßÄ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                    showSaveStatus(true);
                }
            };
            reader.readAsText(file);

            event.target.value = '';
        }

        // Í≥ÑÏ†ï ÌÄòÏä§Ìä∏ Ï¥àÍ∏∞Ìôî Ìï®Ïàò Ï∂îÍ∞Ä
        function resetAccountQuests() {
            if (!confirm('Ï†ïÎßê Î™®Îì† Í≥ÑÏ†ï ÌÄòÏä§Ìä∏Ïùò ÏßÑÌñâÏÉÅÌô©ÏùÑ Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÎ™®Îì† Ï∫êÎ¶≠ÌÑ∞Ïóê Ï†ÅÏö©Îê©ÎãàÎã§.')) return;

            // Í≥ÑÏ†ï ÌÄòÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Î™®Îëê ÏÇ≠Ï†ú
            localStorage.removeItem('mabinogi_account_daily_quest');
            localStorage.removeItem('mabinogi_account_weekly_quest');
            localStorage.removeItem('mabinogi_account_daily_questManagement');
            localStorage.removeItem('mabinogi_account_weekly_questManagement');

            // Î™®Îì† Ï∫êÎ¶≠ÌÑ∞Ïùò Í≥ÑÏ†ï ÌÄòÏä§Ìä∏ UI ÏóÖÎç∞Ïù¥Ìä∏
            const characters = getCharacterList();
            characters.forEach(char => {
                document.querySelectorAll(`tr[data-char='${char.id}']`).forEach(row => {
                    const rowIndex = parseInt(row.getAttribute('data-row'));
                    const dataType = row.getAttribute('data-type') || 'quest';
                    const currentData = dataType === 'quest' ? questData : questManagementData;

                    if (currentData[rowIndex] &&
                        (currentData[rowIndex].type === 'accountDaily' || currentData[rowIndex].type === 'accountWeekly')) {

                        const checkbox = row.querySelector('.checker');
                        if (checkbox) {
                            checkbox.checked = false;
                            row.classList.remove('completed');
                        }

                        // ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨Ïùò Í≤ΩÏö∞ Í∞úÎ≥Ñ Ï≤¥ÌÅ¨Î∞ïÏä§ÎèÑ Ï¥àÍ∏∞Ìôî
                        if (dataType === 'questManagement') {
                            const individualCheckboxes = row.querySelectorAll('.individual-checker');
                            individualCheckboxes.forEach(checkbox => {
                                checkbox.checked = false;
                            });

                            const quest = questManagementData[rowIndex];
                            if (quest) {
                                const progressSpan = row.querySelector('td:nth-child(4) span');
                                if (progressSpan) {
                                    progressSpan.textContent = `0/${quest.count}`;
                                }
                            }
                        }
                    }
                });
                updateProgress(char.id);
            });

            updateStats();
            showSaveStatus();
        }

        function addAccountResetButton() {
            const topControls = document.querySelector('.top-controls .character-management');
            if (topControls && !document.getElementById('accountResetBtn')) {
                const resetBtn = document.createElement('button');
                resetBtn.id = 'accountResetBtn';
                resetBtn.className = 'btn btn-secondary';
                resetBtn.innerHTML = 'üîÑ Í≥ÑÏ†ïÌÄòÏä§Ìä∏ Ï¥àÍ∏∞Ìôî';
                resetBtn.onclick = resetAccountQuests;
                resetBtn.title = 'Î™®Îì† Í≥ÑÏ†ï ÌÄòÏä§Ìä∏ Ï¥àÍ∏∞Ìôî';
                topControls.appendChild(resetBtn);

                // Ïä§ÌÅ¨Î¶∞ÏÉ∑ Î≤ÑÌäº Ï∂îÍ∞Ä
                const screenshotBtn = document.createElement('button');
                screenshotBtn.id = 'screenshotBtn';
                screenshotBtn.className = 'btn btn-secondary';
                screenshotBtn.innerHTML = 'üì∏ Ïä§ÌÅ¨Î¶∞ÏÉ∑';
                screenshotBtn.onclick = takeScreenshot;
                screenshotBtn.title = 'Ï†ÑÏ≤¥ÌôîÎ©¥ Ïä§ÌÅ¨Î¶∞ÏÉ∑';
                topControls.appendChild(screenshotBtn);
            }
        }

        // ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî
        function initializeFilters() {
            const locations = [...new Set(questData.map(q => q.location))];
            const locationFilter = document.getElementById('locationFilter');

            locationFilter.innerHTML = '<option value="all">Ï†ÑÏ≤¥</option>';
            locations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationFilter.appendChild(option);
            });
        }

        function updateFiltersAndUI() {
            initializeFilters();
            applyFilters();
            updateStats();
            updatePageTitle();
        }

        // ÌïÑÌÑ∞ Ï†ÅÏö©
        function applyFilters() {
            const currentTab = getCurrentTab();
            if (currentTab === 'allView') {
                renderAllCharacters();
            }
        }

        // ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨ÏóêÏÑú Í∞úÎ≥Ñ ÌöüÏàò Ï≤¥ÌÅ¨ ÏÉÅÌÉú ÌôïÏù∏
        function isQuestMgmtChecked(charId, questIndex, countIndex) {
            if (questIndex >= questManagementData.length || questIndex < 0) {
                return false;
            }

            const quest = questManagementData[questIndex];
            if (!quest) return false;

            // Í≥ÑÏ†ï ÌÄòÏä§Ìä∏Ïù∏ Í≤ΩÏö∞ Í≥ÑÏ†ï Îç∞Ïù¥ÌÑ∞ÏóêÏÑú ÌôïÏù∏
            if (quest.type === 'accountDaily' || quest.type === 'accountWeekly') {
                const timeType = quest.type === 'accountDaily' ? 'daily' : 'weekly';
                const accountKey = `mabinogi_account_${timeType}_questManagement`;
                const accountData = JSON.parse(localStorage.getItem(accountKey) || '{}');
                const questChecks = accountData[questIndex];

                if (!questChecks || !Array.isArray(questChecks)) {
                    return false;
                }
                return questChecks[countIndex] || false;
            }

            // ÏùºÎ∞ò Ï∫êÎ¶≠ÌÑ∞Î≥Ñ ÌÄòÏä§Ìä∏
            const data = loadCharacterData(charId);
            const checksKey = quest.type === 'weekly' ? 'weeklyQuestMgmtChecks' : 'dailyQuestMgmtChecks';
            const questChecks = data[checksKey] && data[checksKey][questIndex];

            if (!questChecks || !Array.isArray(questChecks)) {
                return false;
            }

            return questChecks[countIndex] || false;
        }

        function setQuestMgmtChecked(charId, questIndex, countIndex, checked) {
            if (questIndex >= questManagementData.length || questIndex < 0) {
                return;
            }

            const quest = questManagementData[questIndex];
            if (!quest) return;

            // Í≥ÑÏ†ï ÌÄòÏä§Ìä∏Ïù∏ Í≤ΩÏö∞ Í≥ÑÏ†ï Îç∞Ïù¥ÌÑ∞Ïóê Ï†ÄÏû•
            if (quest.type === 'accountDaily' || quest.type === 'accountWeekly') {
                const timeType = quest.type === 'accountDaily' ? 'daily' : 'weekly';
                const accountKey = `mabinogi_account_${timeType}_questManagement`;
                const accountData = JSON.parse(localStorage.getItem(accountKey) || '{}');

                if (!accountData[questIndex]) {
                    accountData[questIndex] = new Array(quest.count).fill(false);
                }

                accountData[questIndex][countIndex] = checked;

                // Ï†ÄÏû• Î∞è Î°úÍ∑∏ Ï∂îÍ∞Ä
                localStorage.setItem(accountKey, JSON.stringify(accountData));
                console.log(`Í≥ÑÏ†ï ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•: ${accountKey}`, accountData);

                // Î™®Îì† Ï∫êÎ¶≠ÌÑ∞Ïùò UI ÏóÖÎç∞Ïù¥Ìä∏
                const characters = getCharacterList();
                characters.forEach(char => {
                    document.querySelectorAll(`tr[data-char='${char.id}'][data-row='${questIndex}'][data-type='questManagement']`).forEach(row => {
                        const individualCheckboxes = row.querySelectorAll('.individual-checker');
                        if (individualCheckboxes[countIndex]) {
                            individualCheckboxes[countIndex].checked = checked;
                        }

                        const completedCount = getQuestMgmtCompletedCount(char.id, questIndex);
                        const allCompleted = completedCount === quest.count;

                        const mainCheckbox = row.querySelector('.checker');
                        if (mainCheckbox) {
                            mainCheckbox.checked = allCompleted;
                            row.classList.toggle('completed', allCompleted);
                        }

                        const progressSpan = row.querySelector('td:nth-child(4) span');
                        if (progressSpan) {
                            progressSpan.textContent = `${completedCount}/${quest.count}`;
                        }
                    });
                    updateProgress(char.id);
                });

                // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                updateStats();

                // ÌïÑÌÑ∞Í∞Ä Ï†ÅÏö©Îêú ÏÉÅÌÉúÎùºÎ©¥ ÌÖåÏù¥Î∏îÏùÑ Îã§Ïãú Î†åÎçîÎßÅ
                const currentTab = getCurrentTab();
                if (currentTab === 'allView') {
                    const statusFilter = document.getElementById('statusFilter')?.value;
                    if (statusFilter && statusFilter !== 'all') {
                        setTimeout(() => {
                            renderAllCharacters();
                        }, 0);
                    }
                }
                return;
            }

            // ÏùºÎ∞ò Ï∫êÎ¶≠ÌÑ∞Î≥Ñ ÌÄòÏä§Ìä∏
            const data = loadCharacterData(charId);
            const checksKey = quest.type === 'weekly' ? 'weeklyQuestMgmtChecks' : 'dailyQuestMgmtChecks';

            if (!data[checksKey]) {
                data[checksKey] = {};
            }

            if (!data[checksKey][questIndex]) {
                data[checksKey][questIndex] = new Array(quest.count).fill(false);
            }

            data[checksKey][questIndex][countIndex] = checked;
            saveCharacterData(charId, data);
        }

        function getQuestMgmtCompletedCount(charId, questIndex) {
            if (questIndex >= questManagementData.length || questIndex < 0) {
                return 0;
            }

            const quest = questManagementData[questIndex];
            if (!quest) return 0;

            // Í≥ÑÏ†ï ÌÄòÏä§Ìä∏Ïù∏ Í≤ΩÏö∞ Í≥ÑÏ†ï Îç∞Ïù¥ÌÑ∞ÏóêÏÑú ÌôïÏù∏
            if (quest.type === 'accountDaily' || quest.type === 'accountWeekly') {
                const timeType = quest.type === 'accountDaily' ? 'daily' : 'weekly';
                const accountKey = `mabinogi_account_${timeType}_questManagement`;
                const accountData = JSON.parse(localStorage.getItem(accountKey) || '{}');
                const questChecks = accountData[questIndex];

                if (!questChecks || !Array.isArray(questChecks)) {
                    return 0;
                }
                return questChecks.filter(check => check === true).length;
            }

            // ÏùºÎ∞ò Ï∫êÎ¶≠ÌÑ∞Î≥Ñ ÌÄòÏä§Ìä∏
            const data = loadCharacterData(charId);
            const checksKey = quest.type === 'weekly' ? 'weeklyQuestMgmtChecks' : 'dailyQuestMgmtChecks';
            const questChecks = data[checksKey] && data[checksKey][questIndex];

            if (!questChecks || !Array.isArray(questChecks)) {
                return 0;
            }

            return questChecks.filter(check => check === true).length;
        }

        // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateStats() {
            const characters = getCharacterList();
            let totalCompleted = 0;
            let totalQuests = 0;
            let dailyCompleted = 0;
            let dailyTotal = 0;
            let weeklyCompleted = 0;
            let weeklyTotal = 0;

            const tradeQuestCount = questData.length;
            const tradeDailyCount = questData.filter(q => q.type === 'daily').length;
            const tradeWeeklyCount = questData.filter(q => q.type === 'weekly').length;
            const questMgmtTotalCount = questManagementData.reduce((sum, quest) => sum + quest.count, 0);
            const questMgmtDailyCount = questManagementData.filter(q => q.type === 'daily').reduce((sum, quest) => sum + quest.count, 0);
            const questMgmtWeeklyCount = questManagementData.filter(q => q.type === 'weekly').reduce((sum, quest) => sum + quest.count, 0);

            const tradeAccountDailyCount = questData.filter(q => q.type === 'accountDaily').length;
            const tradeAccountWeeklyCount = questData.filter(q => q.type === 'accountWeekly').length;
            const questMgmtAccountDailyCount = questManagementData.filter(q => q.type === 'accountDaily').reduce((sum, quest) => sum + quest.count, 0);
            const questMgmtAccountWeeklyCount = questManagementData.filter(q => q.type === 'accountWeekly').reduce((sum, quest) => sum + quest.count, 0);

            // Í≥ÑÏ†ï ÌÄòÏä§Ìä∏Îäî Ìïú Î≤àÎßå Í≥ÑÏÇ∞
            const accountDailyCompleted = getAccountCompletedCount('daily');
            const accountWeeklyCompleted = getAccountCompletedCount('weekly');

            const totalQuestCount = tradeQuestCount + questMgmtTotalCount;
            const dailyQuestCount = tradeDailyCount + questMgmtDailyCount + tradeAccountDailyCount + questMgmtAccountDailyCount;
            const weeklyQuestCount = tradeWeeklyCount + questMgmtWeeklyCount + tradeAccountWeeklyCount + questMgmtAccountWeeklyCount;

            // Ï∫êÎ¶≠ÌÑ∞Î≥Ñ ÌÄòÏä§Ìä∏Îßå Î£®ÌîÑÏóêÏÑú Í≥ÑÏÇ∞
            characters.forEach(char => {
                const data = cleanupCharacterData(char.id);

                const tradeDaily = Object.keys(data.dailyChecks || {}).length;
                const tradeWeekly = Object.keys(data.weeklyChecks || {}).length;

                let questMgmtDaily = 0;
                let questMgmtWeekly = 0;

                questManagementData.forEach((quest, index) => {
                    const completedCount = getQuestMgmtCompletedCount(char.id, index);
                    if (quest.type === 'daily') {
                        questMgmtDaily += completedCount;
                    } else if (quest.type === 'weekly') {
                        questMgmtWeekly += completedCount;
                    }
                });

                const totalCharCompleted = tradeDaily + tradeWeekly + questMgmtDaily + questMgmtWeekly;

                totalCompleted += totalCharCompleted;
                totalQuests += totalQuestCount;

                dailyCompleted += tradeDaily + questMgmtDaily;
                dailyTotal += dailyQuestCount;

                weeklyCompleted += tradeWeekly + questMgmtWeekly;
                weeklyTotal += weeklyQuestCount;
            });

            // Í≥ÑÏ†ï ÌÄòÏä§Ìä∏Îäî Î£®ÌîÑ Î∞ñÏóêÏÑú Ìïú Î≤àÎßå Ï∂îÍ∞Ä
            totalCompleted += accountDailyCompleted + accountWeeklyCompleted;
            dailyCompleted += accountDailyCompleted;
            weeklyCompleted += accountWeeklyCompleted;

            const totalPercent = totalQuests > 0 ? Math.round((totalCompleted / totalQuests) * 100) : 0;
            const dailyPercent = dailyTotal > 0 ? Math.round((dailyCompleted / dailyTotal) * 100) : 0;
            const weeklyPercent = weeklyTotal > 0 ? Math.round((weeklyCompleted / weeklyTotal) * 100) : 0;

            document.getElementById('totalCompletion').textContent = `${totalPercent}%`;
            document.getElementById('dailyCompletion').textContent = `${dailyPercent}%`;
            document.getElementById('weeklyCompletion').textContent = `${weeklyPercent}%`;
            document.getElementById('activeCharacters').textContent = characters.length;
        }

        function getAccountCompletedCount(timeType) {
            let completed = 0;

            // Í≥ÑÏ†ï Î¨ºÎ¨ºÍµêÌôò
            const accountTradeKey = `mabinogi_account_${timeType}_quest`;
            const accountTradeData = JSON.parse(localStorage.getItem(accountTradeKey) || '{}');
            completed += Object.keys(accountTradeData).length;

            // Í≥ÑÏ†ï ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨
            const accountQuestKey = `mabinogi_account_${timeType}_questManagement`;
            const accountQuestData = JSON.parse(localStorage.getItem(accountQuestKey) || '{}');
            Object.values(accountQuestData).forEach(questChecks => {
                if (Array.isArray(questChecks)) {
                    completed += questChecks.filter(check => check === true).length;
                }
            });

            return completed;
        }

        // Ï∫êÎ¶≠ÌÑ∞ Ï∂îÍ∞Ä
        function addCharacter() {
            const nameInput = document.getElementById('newCharName');
            const name = nameInput.value.trim();

            if (!name) {
                alert('Ï∫êÎ¶≠ÌÑ∞Î™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }

            const characters = getCharacterList();
            if (characters.some(char => char.name === name)) {
                alert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Ï∫êÎ¶≠ÌÑ∞Î™ÖÏûÖÎãàÎã§!');
                return;
            }

            const newChar = {
                id: generateCharacterId(),
                name: name
            };

            characters.push(newChar);
            saveCharacterList(characters);
            nameInput.value = '';

            renderTabs();
            renderAllCharacters();
            updateStats();
            updatePageTitle();
        }

        // Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú
        function deleteCharacter(charId) {
            if (!confirm('Ï†ïÎßê Ïù¥ Ï∫êÎ¶≠ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÎ™®Îì† ÏßÑÌñâ Îç∞Ïù¥ÌÑ∞Í∞Ä Ìï®Íªò ÏÇ≠Ï†úÎê©ÎãàÎã§.')) {
                return;
            }

            const characters = getCharacterList();
            const filtered = characters.filter(char => char.id !== charId);
            saveCharacterList(filtered);

            localStorage.removeItem(`mabinogi_${charId}`);

            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab && activeTab.getAttribute('data-target') === `#char_${charId}`) {
                switchToTab('allView');
                saveCurrentTab('allView');
            }

            renderTabs();
            renderAllCharacters();
            updateStats();
            updatePageTitle();
        }

        // Ï∫êÎ¶≠ÌÑ∞Î™Ö ÏàòÏ†ï
        function editCharacterName(charId, currentName) {
            const newName = prompt('ÏÉà Ï∫êÎ¶≠ÌÑ∞Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', currentName);
            if (!newName || newName.trim() === '' || newName === currentName) {
                return;
            }

            const trimmedName = newName.trim();
            const characters = getCharacterList();

            if (characters.some(char => char.name === trimmedName && char.id !== charId)) {
                alert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Ï∫êÎ¶≠ÌÑ∞Î™ÖÏûÖÎãàÎã§!');
                return;
            }

            const char = characters.find(c => c.id === charId);
            if (char) {
                char.name = trimmedName;
                saveCharacterList(characters);

                renderTabs();
                renderAllCharacters();

                const currentTab = getCurrentTab();
                switchToTab(currentTab);
            }
        }

        // Îç∞Ïù¥ÌÑ∞ Î°úÎìú Î∞è ÏûêÎèô Ï¥àÍ∏∞Ìôî
        function loadCharacterData(charId) {
            const key = `mabinogi_${charId}`;
            const stored = localStorage.getItem(key);
            const currentDaily = getCurrentLogicDate();
            const currentWeekly = getCurrentWeekStart();

            let data = {
                lastDailyReset: currentDaily,
                lastWeeklyReset: currentWeekly,
                dailyChecks: {},
                weeklyChecks: {},
                dailyQuestMgmtChecks: {},
                weeklyQuestMgmtChecks: {},
                accountChecks: {},
                accountQuestMgmtChecks: {},
                characterMemo: ''
            };

            if (stored) {
                const parsed = JSON.parse(stored);
                data = { ...data, ...parsed };

                if (data.lastDailyReset !== currentDaily) {
                    data.dailyChecks = {};
                    data.dailyQuestMgmtChecks = {};
                    data.lastDailyReset = currentDaily;
                }

                if (data.lastWeeklyReset !== currentWeekly) {
                    data.weeklyChecks = {};
                    data.weeklyQuestMgmtChecks = {};
                    data.lastWeeklyReset = currentWeekly;
                }
            }

            localStorage.setItem(key, JSON.stringify(data));
            return data;
        }

        // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        function saveCharacterData(charId, data) {
            try {
                const key = `mabinogi_${charId}`;
                localStorage.setItem(key, JSON.stringify(data));
                showSaveStatus();
            } catch (error) {
                console.error('Save failed:', error);
                showSaveStatus(true);
            }
        }

        // Ï≤¥ÌÅ¨ ÏÉÅÌÉú ÌôïÏù∏ (Î¨ºÎ¨ºÍµêÌôòÏö©)
        function isChecked(charId, rowIndex, dataType = 'quest') {
            const totalQuestDataLength = dataType === 'quest' ? questData.length : questManagementData.length;

            if (rowIndex >= totalQuestDataLength || rowIndex < 0) {
                return false;
            }

            const currentData = dataType === 'quest' ? questData : questManagementData;
            const item = currentData[rowIndex];

            if (!item) return false;

            // Í≥ÑÏ†ï ÌÄòÏä§Ìä∏ Ï≤¥ÌÅ¨ - Î¨ºÎ¨ºÍµêÌôò
            if (dataType === 'quest' && (item.type === 'accountDaily' || item.type === 'accountWeekly')) {
                return isAccountChecked(rowIndex, dataType);
            }

            // Í≥ÑÏ†ï ÌÄòÏä§Ìä∏ Ï≤¥ÌÅ¨ - ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨ (Ï†ÑÏ≤¥ ÏôÑÎ£å Ïó¨Î∂Ä)
            if (dataType === 'questManagement' && (item.type === 'accountDaily' || item.type === 'accountWeekly')) {
                const completedCount = getQuestMgmtCompletedCount(charId, rowIndex);
                return completedCount === item.count;
            }

            // ÏùºÎ∞ò ÌÄòÏä§Ìä∏
            if (dataType === 'quest') {
                const data = loadCharacterData(charId);
                return item.type === 'weekly' ? data.weeklyChecks[rowIndex] : data.dailyChecks[rowIndex];
            } else {
                const data = loadCharacterData(charId);
                const checksKey = item.type === 'weekly' ? 'weeklyQuestMgmtChecks' : 'dailyQuestMgmtChecks';
                const questChecks = data[checksKey] && data[checksKey][rowIndex];

                if (!questChecks || !Array.isArray(questChecks)) {
                    return false;
                }

                return questChecks.every(check => check === true);
            }
        }

        function setChecked(charId, rowIndex, checked, dataType = 'quest') {
            const totalQuestDataLength = dataType === 'quest' ? questData.length : questManagementData.length;

            if (rowIndex >= totalQuestDataLength || rowIndex < 0) {
                return;
            }

            const currentData = dataType === 'quest' ? questData : questManagementData;
            const item = currentData[rowIndex];

            if (!item) return;

            // Í≥ÑÏ†ï ÌÄòÏä§Ìä∏ Ï≤òÎ¶¨ - Î¨ºÎ¨ºÍµêÌôò
            if (dataType === 'quest' && (item.type === 'accountDaily' || item.type === 'accountWeekly')) {
                setAccountChecked(rowIndex, checked, dataType);
                return;
            }

            // Í≥ÑÏ†ï ÌÄòÏä§Ìä∏ Ï≤òÎ¶¨ - ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨
            if (dataType === 'questManagement' && (item.type === 'accountDaily' || item.type === 'accountWeekly')) {
                const timeType = item.type === 'accountDaily' ? 'daily' : 'weekly';
                const accountKey = `mabinogi_account_${timeType}_questManagement`;
                const accountData = JSON.parse(localStorage.getItem(accountKey) || '{}');

                if (!accountData[rowIndex]) {
                    accountData[rowIndex] = new Array(item.count).fill(false);
                }

                // Ï†ÑÏ≤¥ Ï≤¥ÌÅ¨/Ï≤¥ÌÅ¨Ìï¥Ï†ú
                accountData[rowIndex] = new Array(item.count).fill(checked);
                localStorage.setItem(accountKey, JSON.stringify(accountData));
                console.log(`Í≥ÑÏ†ï ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨ Ï†ÑÏ≤¥ ÏÑ§Ï†ï: ${accountKey}`, accountData);

                // Î™®Îì† Ï∫êÎ¶≠ÌÑ∞ UI ÏóÖÎç∞Ïù¥Ìä∏
                const characters = getCharacterList();
                characters.forEach(char => {
                    document.querySelectorAll(`tr[data-char='${char.id}'][data-row='${rowIndex}'][data-type='questManagement']`).forEach(row => {
                        const individualCheckboxes = row.querySelectorAll('.individual-checker');
                        individualCheckboxes.forEach(checkbox => {
                            checkbox.checked = checked;
                        });

                        const mainCheckbox = row.querySelector('.checker');
                        if (mainCheckbox) {
                            mainCheckbox.checked = checked;
                            row.classList.toggle('completed', checked);
                        }

                        const progressSpan = row.querySelector('td:nth-child(4) span');
                        if (progressSpan) {
                            const count = checked ? item.count : 0;
                            progressSpan.textContent = `${count}/${item.count}`;
                        }
                    });
                    updateProgress(char.id);
                });

                updateStats();
                return;
            }

            // ÏùºÎ∞ò ÌÄòÏä§Ìä∏ Ï≤òÎ¶¨
            const data = loadCharacterData(charId);

            if (dataType === 'quest') {
                if (item.type === 'weekly') {
                    if (checked) {
                        data.weeklyChecks[rowIndex] = true;
                    } else {
                        delete data.weeklyChecks[rowIndex];
                    }
                } else {
                    if (checked) {
                        data.dailyChecks[rowIndex] = true;
                    } else {
                        delete data.dailyChecks[rowIndex];
                    }
                }
            } else {
                const checksKey = item.type === 'weekly' ? 'weeklyQuestMgmtChecks' : 'dailyQuestMgmtChecks';

                if (!data[checksKey]) {
                    data[checksKey] = {};
                }

                if (checked) {
                    data[checksKey][rowIndex] = new Array(item.count).fill(true);
                } else {
                    data[checksKey][rowIndex] = new Array(item.count).fill(false);
                }
            }

            saveCharacterData(charId, data);
        }

        // Ï∫êÎ¶≠ÌÑ∞ Î©îÎ™® Ï†ÄÏû•
        function saveCharacterMemo(charId, memo) {
            const data = loadCharacterData(charId);
            if (memo.trim()) {
                data.characterMemo = memo.trim();
            } else {
                delete data.characterMemo;
            }
            saveCharacterData(charId, data);
        }

        // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
        function updateProgress(charId) {
            const data = cleanupCharacterData(charId);

            // Ï∫êÎ¶≠ÌÑ∞Î≥Ñ Î¨ºÎ¨ºÍµêÌôò (Í≥ÑÏ†ï ÌÄòÏä§Ìä∏ Ï†úÏô∏)
            let tradeCompleted = 0;
            Object.keys(data.dailyChecks || {}).forEach(key => {
                const idx = parseInt(key);
                if (questData[idx] && questData[idx].type !== 'accountDaily' && questData[idx].type !== 'accountWeekly') {
                    tradeCompleted++;
                }
            });
            Object.keys(data.weeklyChecks || {}).forEach(key => {
                const idx = parseInt(key);
                if (questData[idx] && questData[idx].type !== 'accountDaily' && questData[idx].type !== 'accountWeekly') {
                    tradeCompleted++;
                }
            });

            let questMgmtCompleted = 0;
            questManagementData.forEach((quest, index) => {
                // Í≥ÑÏ†ï ÌÄòÏä§Ìä∏Í∞Ä ÏïÑÎãå Í≤ΩÏö∞Îßå Í∞úÎ≥Ñ Ï∫êÎ¶≠ÌÑ∞ ÏßÑÌñâÎ•†Ïóê Ìè¨Ìï®
                if (quest.type !== 'accountDaily' && quest.type !== 'accountWeekly') {
                    questMgmtCompleted += getQuestMgmtCompletedCount(charId, index);
                }
            });

            // Î¨ºÎ¨ºÍµêÌôòÎèÑ ÎßàÏ∞¨Í∞ÄÏßÄÎ°ú Í≥ÑÏ†ï ÌÄòÏä§Ìä∏ Ï†úÏô∏
            const nonAccountTradeQuests = questData.filter(q => q.type !== 'accountDaily' && q.type !== 'accountWeekly').length;
            const nonAccountQuestMgmtCount = questManagementData
                .filter(q => q.type !== 'accountDaily' && q.type !== 'accountWeekly')
                .reduce((sum, quest) => sum + quest.count, 0);

            const totalQuests = nonAccountTradeQuests + nonAccountQuestMgmtCount;
            const completed = tradeCompleted + questMgmtCompleted;
            const percentage = totalQuests > 0 ? Math.round((completed / totalQuests) * 100) : 0;

            const progressTextAll = document.getElementById(`progress-all-${charId}`);
            const progressBarAll = document.getElementById(`bar-all-${charId}`);

            if (progressTextAll) progressTextAll.textContent = `${completed}/${totalQuests} (${percentage}%)`;
            if (progressBarAll) progressBarAll.style.width = `${percentage}%`;

            const progressText = document.getElementById(`progress-${charId}`);
            const progressBar = document.getElementById(`bar-${charId}`);

            if (progressText) progressText.textContent = `${completed}/${totalQuests} (${percentage}%)`;
            if (progressBar) progressBar.style.width = `${percentage}%`;

            updateStats();
            updatePageTitle();
        }

        // ÌÄòÏä§Ìä∏ ÌÖåÏù¥Î∏î ÏÉùÏÑ±
        function createQuestTable(charId, isOverview = false) {
            const materialSection = `
        <div>
            <h4 style="margin: 15px 0 10px 0; color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">üß∞ Î≥¥Ïú† Ïû¨Î£å</h4>
            ${createMaterialSection(charId)}
        </div>
    `;

            const tradeSection = `
        <div style="margin-bottom: 20px;">
            <h4 style="margin: 15px 0 10px 0; color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">üì¶ Î¨ºÎ¨ºÍµêÌôò</h4>
            ${createSingleQuestTable(charId, questData, 'quest', isOverview)}
        </div>
    `;

            const questSection = `
        <div style="margin-bottom: 20px;">
            <h4 style="margin: 15px 0 10px 0; color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">‚öîÔ∏è ÌÄòÏä§Ìä∏</h4>
            ${createSingleQuestTable(charId, questManagementData, 'questManagement', isOverview)}
        </div>
    `;

            return materialSection + tradeSection + questSection;
        }

        function createMaterialSection(charId) {
            if (materialData.length === 0) {
                return '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">Îì±Î°ùÎêú Ïû¨Î£åÍ∞Ä ÏóÜÏäµÎãàÎã§</div>';
            }

            const materialItems = materialData.map((material, index) => {
                const currentCount = getMaterialCount(charId, index);
                return `
            <div class="material-item" data-char="${charId}" data-material="${index}">
                <span class="material-item-name">${material.name}</span>
                <div class="material-input-container">
                    <input 
                        type="number" 
                        class="material-count-input" 
                        data-char="${charId}" 
                        data-material="${index}"
                        value="${currentCount}" 
                        min="0" 
                        max="99999"
                        placeholder="0"
                    >
                    <span class="material-count-display">Í∞ú</span>
                </div>
            </div>
        `;
            }).join('');

            return `<div class="material-grid">${materialItems}</div>`;
        }

        // Ïû¨Î£å Í∞úÏàò Í¥ÄÎ†® Ìï®ÏàòÎì§
        function getMaterialCount(charId, materialIndex) {
            const data = loadCharacterData(charId);
            return (data.materialCounts && data.materialCounts[materialIndex]) || 0;
        }

        function setMaterialCount(charId, materialIndex, count) {
            const data = loadCharacterData(charId);
            if (!data.materialCounts) {
                data.materialCounts = {};
            }

            if (count > 0) {
                data.materialCounts[materialIndex] = count;
            } else {
                delete data.materialCounts[materialIndex];
            }

            saveCharacterData(charId, data);
        }

        // Ïû¨Î£å ÏÇ≠Ï†ú Ïãú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
        function updateCharacterDataAfterMaterialDeletion(deletedIndex) {
            const characters = getCharacterList();
            characters.forEach(char => {
                const data = loadCharacterData(char.id);

                if (data.materialCounts) {
                    const newMaterialCounts = {};
                    Object.keys(data.materialCounts).forEach(key => {
                        const idx = parseInt(key);
                        if (idx < deletedIndex) {
                            newMaterialCounts[idx] = data.materialCounts[key];
                        } else if (idx > deletedIndex) {
                            newMaterialCounts[idx - 1] = data.materialCounts[key];
                        }
                    });
                    data.materialCounts = newMaterialCounts;
                    saveCharacterData(char.id, data);
                }
            });
        }

        function createSingleQuestTable(charId, dataArray, dataType, isOverview = false) {
            const statusFilter = document.getElementById('statusFilter')?.value || 'all';
            const typeFilter = document.getElementById('typeFilter')?.value || 'all';
            const locationFilter = document.getElementById('locationFilter')?.value || 'all';

            let questsToShow = dataArray.map((item, originalIndex) => {
                return { item, originalIndex };
            });

            questsToShow = questsToShow.filter(({ item }) => {
                if (typeFilter !== 'all' && item.type !== typeFilter) return false;
                if (dataType === 'quest' && locationFilter !== 'all' && item.location !== locationFilter) return false;
                return true;
            });

            if (statusFilter !== 'all') {
                questsToShow = questsToShow.filter(({ originalIndex }) => {
                    const isCompleted = isChecked(charId, originalIndex, dataType);
                    return statusFilter === 'completed' ? isCompleted : !isCompleted;
                });
            }

            if (questsToShow.length === 0) {
                return '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">ÌëúÏãúÌï† Ìï≠Î™©Ïù¥ ÏóÜÏäµÎãàÎã§</div>';
            }

            let headers;
            if (dataType === 'quest') {
                headers = isOverview
                    ? '<tr><th>Íµ¨Î∂Ñ</th><th>ÏúÑÏπò</th><th>NPCÎ™Ö</th><th>ÌïÑÏöîÏïÑÏù¥ÌÖú</th><th>ÏàòÎüâ</th><th>Î≥¥ÏÉÅ</th><th>ÏôÑÎ£å</th></tr>'
                    : '<tr><th>Íµ¨Î∂Ñ</th><th>ÏúÑÏπò</th><th>NPCÎ™Ö</th><th>ÌïÑÏöîÏïÑÏù¥ÌÖú</th><th>ÌïÑÏöîÏàòÎüâ</th><th>Î≥¥ÏÉÅÏïÑÏù¥ÌÖú</th><th>Î≥¥ÏÉÅÏàòÎüâ</th><th>ÏôÑÎ£å</th></tr>';
            } else {
                headers = '<tr><th>Íµ¨Î∂Ñ</th><th>Ïπ¥ÌÖåÍ≥†Î¶¨</th><th>ÌÄòÏä§Ìä∏Î™Ö</th><th>ÏßÑÌñâÎèÑ</th><th>ÏôÑÎ£å</th></tr>';
            }

            const rows = questsToShow.map(({ item, originalIndex }) => {
                const badgeClass = item.type === 'weekly' ? 'weekly-badge' :
                    item.type === 'accountDaily' ? 'account-daily-badge' :
                        item.type === 'accountWeekly' ? 'account-weekly-badge' : 'daily-badge';
                const badgeText = item.type === 'weekly' ? 'Ï£ºÍ∞Ñ' :
                    item.type === 'accountDaily' ? 'Í≥ÑÏ†ïÏùºÍ∞Ñ' :
                        item.type === 'accountWeekly' ? 'Í≥ÑÏ†ïÏ£ºÍ∞Ñ' : 'ÏùºÍ∞Ñ';
                const rowClass = item.type === 'weekly' ? 'weekly' :
                    item.type === 'accountDaily' ? 'account-daily' :
                        item.type === 'accountWeekly' ? 'account-weekly' : '';

                if (dataType === 'quest') {
                    return isOverview
                        ? `<tr class="${rowClass}" data-char="${charId}" data-row="${originalIndex}" data-type="${dataType}">
                    <td><span class="${badgeClass}">${badgeText}</span></td>
                    <td>${item.location}</td>
                    <td>${item.npc}</td>
                    <td>${item.need}</td>
                    <td>${item.needCount}</td>
                    <td>${item.reward} ${item.rewardCount}</td>
                    <td><input type='checkbox' class='checker' data-char="${charId}" data-row="${originalIndex}" data-type="${dataType}"></td>
                   </tr>`
                        : `<tr class="${rowClass}" data-char="${charId}" data-row="${originalIndex}" data-type="${dataType}">
                    <td><span class="${badgeClass}">${badgeText}</span></td>
                    <td>${item.location}</td>
                    <td>${item.npc}</td>
                    <td>${item.need}</td>
                    <td>${item.needCount}</td>
                    <td>${item.reward}</td>
                    <td>${item.rewardCount}</td>
                    <td><input type='checkbox' class='checker' data-char="${charId}" data-row="${originalIndex}" data-type="${dataType}"></td>
                   </tr>`;
                } else {
                    let progressHtml = '<div style="display: flex; align-items: center; gap: 5px; justify-content: center; flex-wrap: wrap;">';
                    for (let i = 0; i < item.count; i++) {
                        progressHtml += `<input type="checkbox" class="individual-checker" data-char="${charId}" data-quest="${originalIndex}" data-count="${i}" title="${i + 1}ÌöåÏ∞®" style="transform: scale(1.1); cursor: pointer; margin: 2px;">`;
                    }
                    const completedCount = getQuestMgmtCompletedCount(charId, originalIndex);
                    progressHtml += `<span style="margin-left: 8px; font-size: 12px; color: var(--text-secondary); display:none;">${completedCount}/${item.count}</span>`;
                    progressHtml += '</div>';

                    return `<tr class="${rowClass}" data-char="${charId}" data-row="${originalIndex}" data-type="${dataType}">
                <td><span class="${badgeClass}">${badgeText}</span></td>
                <td>${item.category}</td>
                <td>${item.name}</td>
                <td>${progressHtml}</td>
                <td><input type='checkbox' class='checker' data-char="${charId}" data-row="${originalIndex}" data-type="${dataType}"></td>
               </tr>`;
                }
            }).join('');

            return `
        <div class="table-container">
            <table>
                <thead>${headers}</thead>
                <tbody>${rows}</tbody>
            </table>
        </div>
    `;
        }

        // ÌÉ≠ Î†åÎçîÎßÅ
        function renderTabs() {
            const tabContainer = document.getElementById('tabContainer');
            const characterTabContainer = document.getElementById('characterTabContainer');
            const characters = getCharacterList();

            let mainTabsHTML = '<button class="tab-btn overview-tab" data-target="#allView">üìã Ï†ÑÏ≤¥ Î≥¥Í∏∞</button>';
            mainTabsHTML += '<button class="tab-btn overview-tab" data-target="#tradeManagement">üì¶ Î¨ºÎ¨ºÍµêÌôò Í¥ÄÎ¶¨</button>';
            mainTabsHTML += '<button class="tab-btn overview-tab" data-target="#questManagement">‚öîÔ∏è ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨</button>';
            mainTabsHTML += '<button class="tab-btn overview-tab" data-target="#materialManagement">üß∞ Ïû¨Î£å Í¥ÄÎ¶¨</button>';

            tabContainer.innerHTML = mainTabsHTML;

            let characterTabsHTML = '';
            characters.forEach(char => {
                characterTabsHTML += `
                    <button class="tab-btn character-tab" data-target="#char_${char.id}">
                        üéØ ${char.name}
                        <span class="delete-char" onclick="event.stopPropagation(); deleteCharacter('${char.id}')" title="Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú">√ó</span>
                    </button>
                `;
            });

            characterTabContainer.innerHTML = characterTabsHTML;

            setupTabEvents();
        }

        // Ï†ÑÏ≤¥Î≥¥Í∏∞ Î†åÎçîÎßÅ
        function renderAllCharacters() {
            const allView = document.getElementById('allView');
            const characters = getCharacterList();
            const emptyState = document.getElementById('emptyState');

            if (characters.length === 0) {
                emptyState.style.display = 'block';
                const characterBoxes = allView.querySelectorAll('.character-box');
                characterBoxes.forEach(box => box.remove());
                return;
            }

            emptyState.style.display = 'none';

            const characterBoxes = allView.querySelectorAll('.character-box');
            characterBoxes.forEach(box => box.remove());

            const totalTradeQuests = questData.length;
            const totalQuestMgmtCount = questManagementData.reduce((sum, quest) => sum + quest.count, 0);
            const totalQuests = totalTradeQuests + totalQuestMgmtCount;

            cleanupAccountData();

            characters.forEach(char => {
                const characterBox = document.createElement('div');
                const data = cleanupCharacterData(char.id);

                characterBox.className = 'character-box';
                characterBox.innerHTML = `
            <h3>
                üéØ <button class="edit-name" onclick="editCharacterName('${char.id}', '${char.name}')">${char.name}</button>
            </h3>
            <div class="progress-info">
                <div>ÏßÑÌñâÎ•†: <span id="progress-all-${char.id}">0/${totalQuests} (0%)</span></div>
                <div class="progress-bar"><div class="progress-fill" id="bar-all-${char.id}"></div></div>
            </div>
            <div style="margin-bottom: 15px;">
                <textarea class="memo-input" placeholder="Ï∫êÎ¶≠ÌÑ∞ Î©îÎ™®..." data-char="${char.id}" style="width: 100%; min-height: 60px;">${loadCharacterData(char.id).characterMemo || ''}</textarea>
            </div>
            ${createQuestTable(char.id, true)}
            <button class="btn btn-danger" onclick="resetCharacter('${char.id}')">üîÑ Ï¥àÍ∏∞Ìôî</button>
        `;

                allView.appendChild(characterBox);

                let charPage = document.getElementById(`char_${char.id}`);
                if (!charPage) {
                    charPage = document.createElement('div');
                    charPage.className = 'character';
                    charPage.id = `char_${char.id}`;
                    document.body.appendChild(charPage);
                }

                charPage.innerHTML = `
            <div class="progress-info">
                <div>${char.name} ÏßÑÌñâÎ•†: <span id="progress-${char.id}">0/${totalQuests} (0%)</span></div>
                <div class="progress-bar"><div class="progress-fill" id="bar-${char.id}"></div></div>
                <small>üí° Ï£ºÍ∞Ñ ÌÄòÏä§Ìä∏Îäî ÎÖ∏ÎûÄÏÉâ, ÏùºÍ∞Ñ ÌÄòÏä§Ìä∏Îäî ÌååÎûÄÏÉâÏúºÎ°ú ÌëúÏãúÎê©ÎãàÎã§</small>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-secondary);">üìù Ï∫êÎ¶≠ÌÑ∞ Î©îÎ™®</label>
                <textarea class="memo-input" placeholder="Ïù¥ Ï∫êÎ¶≠ÌÑ∞Ïóê ÎåÄÌïú Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." data-char="${char.id}" style="width: 100%; min-height: 80px;">${loadCharacterData(char.id).characterMemo || ''}</textarea>
            </div>
            ${createQuestTable(char.id, false)}
            <button class="btn btn-danger" onclick="resetCharacter('${char.id}')">üîÑ Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî</button>
        `;

                restoreCheckStates(char.id);
                updateProgress(char.id);
            });

            setupQuestEvents();
        }

        // Ï≤¥ÌÅ¨ ÏÉÅÌÉú Î≥µÏõê
        function restoreCheckStates(charId) {
            // Îç∞Ïù¥ÌÑ∞ Î¨¥Í≤∞ÏÑ± Í≤ÄÏ¶ù Î®ºÏ†Ä Ïã§Ìñâ
            validateCharacterData(charId);

            document.querySelectorAll(`tr[data-char='${charId}']`).forEach(row => {
                const rowIndex = parseInt(row.getAttribute('data-row'));
                const dataType = row.getAttribute('data-type') || 'quest';

                if (dataType === 'quest') {
                    const totalLength = questData.length;

                    if (rowIndex >= 0 && rowIndex < totalLength) {
                        const quest = questData[rowIndex];

                        // Í≥ÑÏ†ï ÌÄòÏä§Ìä∏Ïù∏ Í≤ΩÏö∞ Í≥ÑÏ†ï Îç∞Ïù¥ÌÑ∞ÏóêÏÑú ÌôïÏù∏
                        if (quest && (quest.type === 'accountDaily' || quest.type === 'accountWeekly')) {
                            const checked = isAccountChecked(rowIndex, dataType);
                            const checkbox = row.querySelector('.checker');
                            if (checkbox) {
                                checkbox.checked = checked;
                                if (checked) row.classList.add('completed');
                            }
                        } else {
                            // ÏùºÎ∞ò ÌÄòÏä§Ìä∏ Ï≤òÎ¶¨
                            const checked = isChecked(charId, rowIndex, dataType);
                            const checkbox = row.querySelector('.checker');
                            if (checkbox) {
                                checkbox.checked = checked;
                                if (checked) row.classList.add('completed');
                            }
                        }
                    }
                } else {
                    // questManagement Ï≤òÎ¶¨
                    const totalLength = questManagementData.length;

                    if (rowIndex >= 0 && rowIndex < totalLength) {
                        const quest = questManagementData[rowIndex];
                        if (quest) {
                            // Í≥ÑÏ†ï ÌÄòÏä§Ìä∏Ïù∏ Í≤ΩÏö∞
                            if (quest.type === 'accountDaily' || quest.type === 'accountWeekly') {
                                // Í∞úÎ≥Ñ Ï≤¥ÌÅ¨Î∞ïÏä§ Î≥µÏõê
                                const individualCheckboxes = row.querySelectorAll('.individual-checker');
                                individualCheckboxes.forEach((checkbox, countIndex) => {
                                    const checked = isQuestMgmtChecked(charId, rowIndex, countIndex);
                                    checkbox.checked = checked;
                                });

                                // Ï†ÑÏ≤¥ ÏôÑÎ£å ÏÉÅÌÉú ÌôïÏù∏
                                const completedCount = getQuestMgmtCompletedCount(charId, rowIndex);
                                const allCompleted = completedCount === quest.count;

                                const mainCheckbox = row.querySelector('.checker');
                                if (mainCheckbox) {
                                    mainCheckbox.checked = allCompleted;
                                    if (allCompleted) row.classList.add('completed');
                                }

                                const progressSpan = row.querySelector('td:nth-child(4) span');
                                if (progressSpan) {
                                    progressSpan.textContent = `${completedCount}/${quest.count}`;
                                }
                            } else {
                                // ÏùºÎ∞ò Ï∫êÎ¶≠ÌÑ∞Î≥Ñ ÌÄòÏä§Ìä∏
                                const individualCheckboxes = row.querySelectorAll('.individual-checker');
                                individualCheckboxes.forEach((checkbox, countIndex) => {
                                    const checked = isQuestMgmtChecked(charId, rowIndex, countIndex);
                                    checkbox.checked = checked;
                                });

                                const completedCount = getQuestMgmtCompletedCount(charId, rowIndex);
                                const allCompleted = completedCount === quest.count;

                                const mainCheckbox = row.querySelector('.checker');
                                if (mainCheckbox) {
                                    mainCheckbox.checked = allCompleted;
                                    if (allCompleted) row.classList.add('completed');
                                }

                                const progressSpan = row.querySelector('td:nth-child(4) span');
                                if (progressSpan) {
                                    progressSpan.textContent = `${completedCount}/${quest.count}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        let updateTimeout = null;

        function debouncedUpdate() {
            if (updateTimeout) {
                clearTimeout(updateTimeout);
            }

            updateTimeout = setTimeout(() => {
                renderAllCharacters();
                updateFiltersAndUI();
                updateTimeout = null;
            }, 150);
        }

        // Ï∫êÎ¶≠ÌÑ∞ Ï¥àÍ∏∞Ìôî
        function resetCharacter(charId) {
            if (!confirm('Ï†ïÎßê Ïù¥ Ï∫êÎ¶≠ÌÑ∞Ïùò Î™®Îì† ÏßÑÌñâÏÉÅÌô©ÏùÑ Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

            const data = {
                lastDailyReset: getCurrentLogicDate(),
                lastWeeklyReset: getCurrentWeekStart(),
                dailyChecks: {},
                weeklyChecks: {},
                dailyQuestMgmtChecks: {},
                weeklyQuestMgmtChecks: {},
                characterMemo: ''
            };

            saveCharacterData(charId, data);

            document.querySelectorAll(`tr[data-char='${charId}']`).forEach(row => {
                const checkbox = row.querySelector('.checker');
                if (checkbox) {
                    checkbox.checked = false;
                    row.classList.remove('completed');
                }

                const individualCheckboxes = row.querySelectorAll('.individual-checker');
                individualCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });

                const progressSpan = row.querySelector('td:nth-child(4) span');
                if (progressSpan) {
                    const dataType = row.getAttribute('data-type');
                    const rowIndex = parseInt(row.getAttribute('data-row'));
                    if (dataType === 'questManagement' && questManagementData[rowIndex]) {
                        const quest = questManagementData[rowIndex];
                        progressSpan.textContent = `0/${quest.count}`;
                    }
                }
            });

            document.querySelectorAll(`textarea[data-char='${charId}']`).forEach(textarea => {
                textarea.value = '';
            });

            updateProgress(charId);
        }

        // Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Ï†ïÎ¶¨
        function cleanupCharacterData(charId) {
            const data = loadCharacterData(charId);
            let changed = false;

            const validDailyChecks = {};
            Object.keys(data.dailyChecks || {}).forEach(key => {
                const idx = parseInt(key);
                if (idx >= 0 && idx < questData.length && questData[idx] &&
                    questData[idx].type === 'daily') { // Í≥ÑÏ†ï ÌÄòÏä§Ìä∏Îäî ÏûêÎèôÏúºÎ°ú Ï†úÏô∏Îê®
                    validDailyChecks[idx] = data.dailyChecks[key];
                } else {
                    changed = true;
                }
            });

            const validWeeklyChecks = {};
            Object.keys(data.weeklyChecks || {}).forEach(key => {
                const idx = parseInt(key);
                if (idx >= 0 && idx < questData.length && questData[idx] &&
                    questData[idx].type === 'weekly') { // Í≥ÑÏ†ï ÌÄòÏä§Ìä∏Îäî ÏûêÎèôÏúºÎ°ú Ï†úÏô∏Îê®
                    validWeeklyChecks[idx] = data.weeklyChecks[key];
                } else {
                    changed = true;
                }
            });

            const validDailyQuestMgmtChecks = {};
            Object.keys(data.dailyQuestMgmtChecks || {}).forEach(key => {
                const idx = parseInt(key);
                if (idx >= 0 && idx < questManagementData.length && questManagementData[idx] && questManagementData[idx].type === 'daily') {
                    const quest = questManagementData[idx];
                    const checks = data.dailyQuestMgmtChecks[key];
                    if (Array.isArray(checks) && checks.length === quest.count) {
                        validDailyQuestMgmtChecks[idx] = checks;
                    } else {
                        validDailyQuestMgmtChecks[idx] = new Array(quest.count).fill(false);
                        changed = true;
                    }
                } else {
                    changed = true;
                }
            });

            const validWeeklyQuestMgmtChecks = {};
            Object.keys(data.weeklyQuestMgmtChecks || {}).forEach(key => {
                const idx = parseInt(key);
                if (idx >= 0 && idx < questManagementData.length && questManagementData[idx] && questManagementData[idx].type === 'weekly') {
                    const quest = questManagementData[idx];
                    const checks = data.weeklyQuestMgmtChecks[key];
                    if (Array.isArray(checks) && checks.length === quest.count) {
                        validWeeklyQuestMgmtChecks[idx] = checks;
                    } else {
                        validWeeklyQuestMgmtChecks[idx] = new Array(quest.count).fill(false);
                        changed = true;
                    }
                } else {
                    changed = true;
                }
            });

            if (changed) {
                data.dailyChecks = validDailyChecks;
                data.weeklyChecks = validWeeklyChecks;
                data.dailyQuestMgmtChecks = validDailyQuestMgmtChecks;
                data.weeklyQuestMgmtChecks = validWeeklyQuestMgmtChecks;
                saveCharacterData(charId, data);
            }

            return data;
        }

        function cleanupAccountData() {
            // Í≥ÑÏ†ï ÏùºÍ∞Ñ Î¨ºÎ¨ºÍµêÌôò Îç∞Ïù¥ÌÑ∞ Ï†ïÎ¶¨
            const accountDailyTradeKey = 'mabinogi_account_daily_quest';
            const accountDailyTradeData = JSON.parse(localStorage.getItem(accountDailyTradeKey) || '{}');
            const validAccountDailyTrade = {};

            Object.keys(accountDailyTradeData).forEach(key => {
                const idx = parseInt(key);
                if (idx >= 0 && idx < questData.length && questData[idx] && questData[idx].type === 'accountDaily') {
                    validAccountDailyTrade[idx] = accountDailyTradeData[key];
                }
            });
            localStorage.setItem(accountDailyTradeKey, JSON.stringify(validAccountDailyTrade));

            // Í≥ÑÏ†ï Ï£ºÍ∞Ñ Î¨ºÎ¨ºÍµêÌôò Îç∞Ïù¥ÌÑ∞ Ï†ïÎ¶¨
            const accountWeeklyTradeKey = 'mabinogi_account_weekly_quest';
            const accountWeeklyTradeData = JSON.parse(localStorage.getItem(accountWeeklyTradeKey) || '{}');
            const validAccountWeeklyTrade = {};

            Object.keys(accountWeeklyTradeData).forEach(key => {
                const idx = parseInt(key);
                if (idx >= 0 && idx < questData.length && questData[idx] && questData[idx].type === 'accountWeekly') {
                    validAccountWeeklyTrade[idx] = accountWeeklyTradeData[key];
                }
            });
            localStorage.setItem(accountWeeklyTradeKey, JSON.stringify(validAccountWeeklyTrade));

            // Í≥ÑÏ†ï ÏùºÍ∞Ñ ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨ Îç∞Ïù¥ÌÑ∞ Ï†ïÎ¶¨
            const accountDailyQuestKey = 'mabinogi_account_daily_questManagement';
            const accountDailyQuestData = JSON.parse(localStorage.getItem(accountDailyQuestKey) || '{}');
            const validAccountDailyQuest = {};

            Object.keys(accountDailyQuestData).forEach(key => {
                const idx = parseInt(key);
                if (idx >= 0 && idx < questManagementData.length && questManagementData[idx] && questManagementData[idx].type === 'accountDaily') {
                    validAccountDailyQuest[idx] = accountDailyQuestData[key];
                }
            });
            localStorage.setItem(accountDailyQuestKey, JSON.stringify(validAccountDailyQuest));

            // Í≥ÑÏ†ï Ï£ºÍ∞Ñ ÌÄòÏä§Ìä∏ Í¥ÄÎ¶¨ Îç∞Ïù¥ÌÑ∞ Ï†ïÎ¶¨
            const accountWeeklyQuestKey = 'mabinogi_account_weekly_questManagement';
            const accountWeeklyQuestData = JSON.parse(localStorage.getItem(accountWeeklyQuestKey) || '{}');
            const validAccountWeeklyQuest = {};

            Object.keys(accountWeeklyQuestData).forEach(key => {
                const idx = parseInt(key);
                if (idx >= 0 && idx < questManagementData.length && questManagementData[idx] && questManagementData[idx].type === 'accountWeekly') {
                    validAccountWeeklyQuest[idx] = accountWeeklyQuestData[key];
                }
            });
            localStorage.setItem(accountWeeklyQuestKey, JSON.stringify(validAccountWeeklyQuest));
        }

        // ÌÉ≠ Í¥ÄÎ†® Ìï®ÏàòÎì§
        function saveCurrentTab(tabId) {
            localStorage.setItem('mabinogi_currentTab', tabId);
        }

        function getCurrentTab() {
            return localStorage.getItem('mabinogi_currentTab') || 'allView';
        }

        function switchToTab(targetId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.character, .all-characters').forEach(content => {
                content.classList.remove('active');
            });

            const targetBtn = document.querySelector(`[data-target="#${targetId}"]`);
            const targetContent = document.getElementById(targetId);

            if (targetBtn) targetBtn.classList.add('active');
            if (targetContent) targetContent.classList.add('active');

            const layoutControls = document.querySelector('.layout-controls');
            if (layoutControls) {
                layoutControls.style.display = targetId === 'allView' ? 'flex' : 'none';
            }

            if (targetId === 'tradeManagement') {
                renderQuestList();
            } else if (targetId === 'questManagement') {
                renderQuestManagementList();
            } else if (targetId === 'materialManagement') {
                renderMaterialList();
            }
        }

        function setupTabEvents() {
            document.querySelectorAll('#tabContainer .tab-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const targetId = this.getAttribute('data-target').substring(1);
                    switchToTab(targetId);
                    saveCurrentTab(targetId);
                });
            });

            document.querySelectorAll('#characterTabContainer .tab-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const targetId = this.getAttribute('data-target').substring(1);
                    switchToTab(targetId);
                    saveCurrentTab(targetId);
                });
            });
        }

        // Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨Îì§
        function setupQuestEvents() {
            document.removeEventListener('click', questClickHandler);
            document.removeEventListener('change', questChangeHandler);
            document.removeEventListener('input', characterMemoInputHandler);

            document.addEventListener('click', questClickHandler);
            document.addEventListener('change', questChangeHandler);
            document.addEventListener('input', characterMemoInputHandler);

            document.addEventListener('input', materialInputHandler);
        }

        function materialInputHandler(e) {
            if (e.target.classList.contains('material-count-input')) {
                const charId = e.target.getAttribute('data-char');
                const materialIndex = parseInt(e.target.getAttribute('data-material'));
                const count = parseInt(e.target.value) || 0;

                clearTimeout(e.target.saveTimer);
                e.target.saveTimer = setTimeout(() => {
                    setMaterialCount(charId, materialIndex, count);
                }, 500);
            }
        }

        function questClickHandler(e) {
            const row = e.target.closest('tr[data-char]');
            if (!row) return;

            if (e.target.type === 'checkbox' || e.target.classList.contains('memo-input')) return;

            const charId = row.getAttribute('data-char');
            const rowIndex = parseInt(row.getAttribute('data-row'));
            const dataType = row.getAttribute('data-type') || 'quest';
            const checkbox = row.querySelector('.checker');

            if (!checkbox) return;

            const newState = !checkbox.checked;
            toggleQuestState(charId, rowIndex, newState, dataType);
        }

        function questChangeHandler(e) {
            if (e.target.classList.contains('checker')) {
                const charId = e.target.getAttribute('data-char');
                const rowIndex = parseInt(e.target.getAttribute('data-row'));
                const dataType = e.target.getAttribute('data-type') || 'quest';
                const newState = e.target.checked;

                toggleQuestState(charId, rowIndex, newState, dataType);
            } else if (e.target.classList.contains('individual-checker')) {
                const charId = e.target.getAttribute('data-char');
                const questIndex = parseInt(e.target.getAttribute('data-quest'));
                const countIndex = parseInt(e.target.getAttribute('data-count'));
                const checked = e.target.checked;

                setQuestMgmtChecked(charId, questIndex, countIndex, checked);

                const quest = questManagementData[questIndex];
                if (quest) {
                    const completedCount = getQuestMgmtCompletedCount(charId, questIndex);
                    const allCompleted = completedCount === quest.count;

                    const row = e.target.closest('tr');
                    const mainCheckbox = row.querySelector('.checker');
                    if (mainCheckbox) {
                        mainCheckbox.checked = allCompleted;
                        row.classList.toggle('completed', allCompleted);
                    }

                    const progressSpan = row.querySelector('td:nth-child(4) span');
                    if (progressSpan) {
                        progressSpan.textContent = `${completedCount}/${quest.count}`;
                    }
                }

                updateProgress(charId);

                // ÌïÑÌÑ∞Í∞Ä Ï†ÅÏö©Îêú ÏÉÅÌÉúÎùºÎ©¥ ÌÖåÏù¥Î∏îÏùÑ Îã§Ïãú Î†åÎçîÎßÅ
                const currentTab = getCurrentTab();
                if (currentTab === 'allView') {
                    const statusFilter = document.getElementById('statusFilter')?.value;
                    if (statusFilter && statusFilter !== 'all') {
                        setTimeout(() => {
                            renderAllCharacters();
                        }, 0);
                    }
                }
            }
        }

        function characterMemoInputHandler(e) {
            if (e.target.classList.contains('memo-input') && e.target.hasAttribute('data-char')) {
                const charId = e.target.getAttribute('data-char');
                const memo = e.target.value;

                clearTimeout(e.target.saveTimer);
                e.target.saveTimer = setTimeout(() => {
                    saveCharacterMemo(charId, memo);
                }, 1000);
            }
        }

        function toggleQuestState(charId, rowIndex, newState, dataType) {
            document.querySelectorAll(`tr[data-char='${charId}'][data-row='${rowIndex}'][data-type='${dataType}']`).forEach(targetRow => {
                const targetCheckbox = targetRow.querySelector('.checker');
                if (targetCheckbox) {
                    targetCheckbox.checked = newState;
                    targetRow.classList.toggle('completed', newState);
                }

                if (dataType === 'questManagement') {
                    const individualCheckboxes = targetRow.querySelectorAll('.individual-checker');
                    individualCheckboxes.forEach(checkbox => {
                        checkbox.checked = newState;
                    });

                    const quest = questManagementData[rowIndex];
                    if (quest) {
                        const progressSpan = targetRow.querySelector('td:nth-child(4) span');
                        if (progressSpan) {
                            const count = newState ? quest.count : 0;
                            progressSpan.textContent = `${count}/${quest.count}`;
                        }
                    }
                }
            });

            setChecked(charId, rowIndex, newState, dataType);
            updateProgress(charId);

            // ÌïÑÌÑ∞Í∞Ä Ï†ÅÏö©Îêú ÏÉÅÌÉúÎùºÎ©¥ ÌÖåÏù¥Î∏îÏùÑ Îã§Ïãú Î†åÎçîÎßÅ
            const currentTab = getCurrentTab();
            if (currentTab === 'allView') {
                const statusFilter = document.getElementById('statusFilter')?.value;
                if (statusFilter && statusFilter !== 'all') {
                    setTimeout(() => {
                        renderAllCharacters();
                    }, 0);
                }
            }
        }

        // Î∏åÎùºÏö∞Ï†Ä ÏïåÎ¶º Í∂åÌïú ÏöîÏ≤≠
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function showNotification(message) {
            if (Notification.permission === 'granted') {
                new Notification('ÎßàÎπÑÎÖ∏Í∏∞ ÌÄòÏä§Ìä∏ ÏïåÎ¶º', {
                    body: message,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üéÆ</text></svg>'
                });
            }
        }

        // Î†àÏù¥ÏïÑÏõÉ Î≥ÄÍ≤Ω Ìï®Ïàò
        function changeLayout(columns) {
            const allView = document.getElementById('allView');

            allView.classList.remove('layout-1', 'layout-2', 'layout-3', 'layout-4');
            allView.classList.add(`layout-${columns}`);

            document.querySelectorAll('.layout-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            event.target.classList.add('active');
            localStorage.setItem('mabinogi_layout', columns);
        }

        // Î†àÏù¥ÏïÑÏõÉ ÏÑ§Ï†ï Î°úÎìú
        function loadLayoutSetting() {
            const savedLayout = localStorage.getItem('mabinogi_layout') || '2';
            const layoutNumber = parseInt(savedLayout);

            const allView = document.getElementById('allView');
            allView.classList.remove('layout-1', 'layout-2', 'layout-3', 'layout-4');
            allView.classList.add(`layout-${layoutNumber}`);

            document.querySelectorAll('.layout-btn').forEach((btn, index) => {
                btn.classList.remove('active');
                if (index + 1 === layoutNumber) {
                    btn.classList.add('active');
                }
            });
        }

        // ÌÖåÎßà Í¥ÄÎ†® Ìï®ÏàòÎì§
        function getTheme() {
            return localStorage.getItem('mabinogi_theme') || 'light';
        }

        function setTheme(theme) {
            localStorage.setItem('mabinogi_theme', theme);
            applyTheme(theme);
        }

        function getSystemTheme() {
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function getEffectiveTheme(theme) {
            if (theme === 'auto') {
                return getSystemTheme();
            }
            return theme;
        }

        function applyTheme(theme) {
            const html = document.documentElement;

            html.classList.add('theme-transitioning');

            requestAnimationFrame(() => {
                const effectiveTheme = getEffectiveTheme(theme);

                if (effectiveTheme === 'dark') {
                    html.setAttribute('data-theme', 'dark');
                } else {
                    html.removeAttribute('data-theme');
                }

                updateThemeIcon(theme);

                setTimeout(() => {
                    html.classList.remove('theme-transitioning');
                }, 300);
            });
        }

        function updateThemeIcon(theme) {
            const icon = document.querySelector('.theme-icon');
            if (!icon) return;

            switch (theme) {
                case 'light':
                    icon.textContent = '‚òÄÔ∏è';
                    icon.parentElement.title = 'ÎùºÏù¥Ìä∏Î™®Îìú (ÌÅ¥Î¶≠: Îã§ÌÅ¨Î™®ÎìúÎ°ú)';
                    break;
                case 'dark':
                    icon.textContent = 'üåô';
                    icon.parentElement.title = 'Îã§ÌÅ¨Î™®Îìú (ÌÅ¥Î¶≠: ÏûêÎèôÎ™®ÎìúÎ°ú)';
                    break;
                case 'auto':
                    const systemTheme = getSystemTheme();
                    icon.textContent = 'üîÑ';
                    icon.parentElement.title = `ÏûêÎèôÎ™®Îìú (ÌòÑÏû¨: ${systemTheme === 'dark' ? 'Îã§ÌÅ¨' : 'ÎùºÏù¥Ìä∏'}) (ÌÅ¥Î¶≠: ÎùºÏù¥Ìä∏Î™®ÎìúÎ°ú)`;
                    break;
                default:
                    icon.textContent = '‚òÄÔ∏è';
                    icon.parentElement.title = 'ÎùºÏù¥Ìä∏Î™®Îìú (ÌÅ¥Î¶≠: Îã§ÌÅ¨Î™®ÎìúÎ°ú)';
            }
        }

        // 3Îã®Í≥Ñ ÌÖåÎßà ÌÜ†Í∏Ä: light ‚Üí dark ‚Üí auto ‚Üí light
        function toggleTheme() {
            const button = document.querySelector('.theme-toggle');
            if (!button || button.disabled) return;

            button.disabled = true;

            const currentTheme = getTheme();
            let newTheme;

            switch (currentTheme) {
                case 'light':
                    newTheme = 'dark';
                    break;
                case 'dark':
                    newTheme = 'auto';
                    break;
                case 'auto':
                default:
                    newTheme = 'light';
                    break;
            }

            console.log(`ÌÖåÎßà Ï†ÑÌôò: ${currentTheme} ‚Üí ${newTheme}`);
            setTheme(newTheme);

            setTimeout(() => {
                button.disabled = false;
            }, 150);
        }

        // ÏãúÏä§ÌÖú ÌÖåÎßà Î≥ÄÍ≤Ω Í∞êÏßÄ Î∞è Ï≤òÎ¶¨
        function initializeThemeSystem() {
            // ÏãúÏä§ÌÖú ÌÖåÎßà Î≥ÄÍ≤Ω Í∞êÏßÄ (auto Î™®ÎìúÏùº ÎïåÎßå Î∞òÏùë)
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                const currentTheme = getTheme();
                if (currentTheme === 'auto') {
                    console.log('ÏãúÏä§ÌÖú ÌÖåÎßà Î≥ÄÍ≤Ω Í∞êÏßÄ, auto Î™®Îìú ÏóÖÎç∞Ïù¥Ìä∏');
                    applyTheme('auto');
                }
            });

            // Ï¥àÍ∏∞ ÌÖåÎßà Ï†ÅÏö©
            const savedTheme = getTheme();
            console.log('Ï†ÄÏû•Îêú ÌÖåÎßà:', savedTheme);
            applyTheme(savedTheme);
        }

        // Ï¥àÍ∏∞Ìôî Ìï®Ïàò
        document.addEventListener('DOMContentLoaded', function () {
            console.log('ÌéòÏù¥ÏßÄ Î°úÎìú ÏãúÏûë');

            //requestNotificationPermission();
            checkAccountDataReset();

            initializeThemeSystem();

            loadQuestData();
            loadQuestManagementData();
            loadMaterialData();
            initializeFilters();

            const characters = getCharacterList();
            if (characters.length === 0) {
                const defaultChar = {
                    id: generateCharacterId(),
                    name: 'Ï∫êÎ¶≠ÌÑ∞1'
                };
                saveCharacterList([defaultChar]);
                console.log('Í∏∞Î≥∏ Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±:', defaultChar);
            }
            validateAllCharacterData();

            renderTabs();
            renderAllCharacters();
            updateStats();

            const currentTab = getCurrentTab();
            switchToTab(currentTab);

            const nameInput = document.getElementById('newCharName');
            nameInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    addCharacter();
                }
            });

            addAccountResetButton();
            updateResetTimers();
            setInterval(updateResetTimers, 1000);
            loadLayoutSetting();

            console.log('Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
        });

        // Í∞úÏÑ†Îêú HTML2Canvas Ïä§ÌÅ¨Î¶∞ÏÉ∑ (CSS Íπ®Ïßê ÏµúÏÜåÌôî)
        async function takeScreenshot() {
            const screenshotBtn = document.getElementById('screenshotBtn');

            try {
                screenshotBtn.disabled = true;
                screenshotBtn.innerHTML = 'üì∏ Ï≤òÎ¶¨Ï§ë...';

                // Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏúÑÎ°ú
                window.scrollTo(0, 0);
                await new Promise(resolve => setTimeout(resolve, 500));

                // CSS Î≥ÄÏàòÎì§ÏùÑ ÏßÅÏ†ë ÏùΩÏñ¥ÏÑú Í≥†Ï†ïÍ∞íÏúºÎ°ú Î≥ÄÌôò
                const computedStyle = getComputedStyle(document.documentElement);
                const isDark = document.documentElement.hasAttribute('data-theme');

                const options = {
                    allowTaint: true,
                    useCORS: true,
                    scale: 1,
                    backgroundColor: isDark ? '#1f2937' : '#ffffff',
                    width: window.innerWidth,
                    height: Math.max(
                        document.body.scrollHeight,
                        document.body.offsetHeight,
                        document.documentElement.clientHeight,
                        document.documentElement.scrollHeight,
                        document.documentElement.offsetHeight
                    ),
                    x: 0,
                    y: 0,
                    scrollX: 0,
                    scrollY: 0,
                    foreignObjectRendering: true,
                    removeContainer: true,
                    logging: false,
                    onclone: (clonedDoc) => {
                        // ÌÅ¥Î°†Îêú Î¨∏ÏÑúÏóêÏÑú CSS Î≥ÄÏàòÎ•º Í≥†Ï†ïÍ∞íÏúºÎ°ú ÍµêÏ≤¥
                        const clonedRoot = clonedDoc.documentElement;

                        // Î™®Îì† Ïä§ÌÉÄÏùºÏãúÌä∏ÏóêÏÑú CSS Î≥ÄÏàò ÏÇ¨Ïö©ÌïòÎäî Î∂ÄÎ∂ÑÏùÑ Í≥†Ï†ïÍ∞íÏúºÎ°ú ÍµêÏ≤¥
                        const allElements = clonedDoc.querySelectorAll('*');
                        allElements.forEach(element => {
                            const style = element.style;

                            // CSS Î≥ÄÏàòÎ•º ÏÇ¨Ïö©ÌïòÎäî ÏÜçÏÑ±Îì§ÏùÑ Í≥†Ï†ïÍ∞íÏúºÎ°ú ÍµêÏ≤¥
                            if (style.color && style.color.includes('var(')) {
                                style.color = isDark ? '#f9fafb' : '#1f2937';
                            }
                            if (style.backgroundColor && style.backgroundColor.includes('var(')) {
                                style.backgroundColor = isDark ? '#1f2937' : '#ffffff';
                            }
                            if (style.borderColor && style.borderColor.includes('var(')) {
                                style.borderColor = isDark ? '#374151' : '#e5e7eb';
                            }
                        });

                        // Ïù∏ÎùºÏù∏ Ïä§ÌÉÄÏùºÎ°ú Í∏∞Î≥∏ ÏÉâÏÉÅ Í∞ïÏ†ú Ï†ÅÏö©
                        const styleElement = clonedDoc.createElement('style');
                        styleElement.textContent = `
                    * { 
                        color: ${isDark ? '#f9fafb' : '#1f2937'} !important;
                        border-color: ${isDark ? '#374151' : '#e5e7eb'} !important;
                    }
                    body { 
                        background-color: ${isDark ? '#1f2937' : '#ffffff'} !important;
                    }
                    .character-box, .quest-management {
                        background-color: ${isDark ? '#111827' : '#f8fafc'} !important;
                        border: 1px solid ${isDark ? '#374151' : '#e5e7eb'} !important;
                    }
                    table {
                        background-color: ${isDark ? '#111827' : '#ffffff'} !important;
                        border: 1px solid ${isDark ? '#374151' : '#e5e7eb'} !important;
                    }
                    th, td {
                        border-color: ${isDark ? '#374151' : '#e5e7eb'} !important;
                        background-color: ${isDark ? '#1f2937' : '#ffffff'} !important;
                    }
                    .btn {
                        background-color: ${isDark ? '#374151' : '#f3f4f6'} !important;
                        color: ${isDark ? '#f9fafb' : '#1f2937'} !important;
                        border-color: ${isDark ? '#4b5563' : '#d1d5db'} !important;
                    }
                `;
                        clonedDoc.head.appendChild(styleElement);
                    }
                };

                const canvas = await html2canvas(document.body, options);
                downloadScreenshot(canvas);
                showSaveStatus();

            } catch (error) {
                console.error('Ïä§ÌÅ¨Î¶∞ÏÉ∑ ÏÉùÏÑ± Ïã§Ìå®:', error);
                alert('Ïä§ÌÅ¨Î¶∞ÏÉ∑ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ® ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                showSaveStatus(true);
            } finally {
                screenshotBtn.disabled = false;
                screenshotBtn.innerHTML = 'üì∏ Ïä§ÌÅ¨Î¶∞ÏÉ∑';
            }
        }

        // Îã§Ïö¥Î°úÎìú Ìï®Ïàò
        function downloadScreenshot(canvas) {
            try {
                const link = document.createElement('a');
                const currentTime = new Date();
                const timestamp = currentTime.getFullYear() + '-' +
                    String(currentTime.getMonth() + 1).padStart(2, '0') + '-' +
                    String(currentTime.getDate()).padStart(2, '0') + '_' +
                    String(currentTime.getHours()).padStart(2, '0') + '-' +
                    String(currentTime.getMinutes()).padStart(2, '0') + '-' +
                    String(currentTime.getSeconds()).padStart(2, '0');

                link.download = `ÎßàÎπÑÎÖ∏Í∏∞_Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏_${timestamp}.png`;
                link.href = canvas.toDataURL('image/png', 1.0);

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('Îã§Ïö¥Î°úÎìú Ïã§Ìå®:', error);
                alert('Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }
    </script>
</body>

</html>